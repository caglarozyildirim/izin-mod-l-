<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Tez Medikal ƒ∞zin Y√∂netimi</title>
    <link rel="stylesheet" href="css/design-system.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-brand">
            <div style="width: 40px; height: 40px; background: var(--primary); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">TM</div>
            <span>Tez Medikal</span>
        </div>

        <div class="navbar-menu" id="navbarMenu">
            <a href="dashboard.html" class="nav-link active">Dashboard</a>
            <a href="izinlerim.html" class="nav-link">ƒ∞zinlerim</a>
            <a href="yeni-talep.html" class="nav-link">Yeni Talep</a>
        </div>

        <div class="navbar-user">
            <div class="user-info">
                <div class="user-name" id="userName">Y√ºkleniyor...</div>
                <div class="user-role" id="userRole">-</div>
            </div>
            <div class="user-avatar" id="userAvatar">-</div>
            <button class="btn btn-ghost btn-sm" data-action="logout">√áƒ±kƒ±≈ü</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container-fluid">
            <!-- Page Header -->
            <div class="page-header">
                <div>
                    <h1 class="page-title" id="pageTitle">Dashboard</h1>
                    <p class="page-subtitle" id="pageSubtitle">ƒ∞zin bilgilerinizi takip edin</p>
                </div>
            </div>

            <!-- PERSONEL G√ñR√úN√úM√ú -->
            <div id="employeeView" style="display: none;">
                <!-- Stats Grid -->
                <div class="grid grid-cols-4 mb-5">
                    <!-- Hak Edilen ƒ∞zin - Calendar Icon -->
                    <div class="stat-card" style="position: relative; overflow: visible;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div class="stat-label">Hak Edilen ƒ∞zin</div>
                                <div class="stat-value" id="earnedLeave" style="font-size: 42px;">20</div>
                                <div class="stat-subtitle">G√ºn</div>
                            </div>
                            <div style="position: relative;">
                                <svg width="70" height="70" viewBox="0 0 70 70" style="overflow: visible;">
                                    <!-- Calendar base -->
                                    <rect x="10" y="15" width="50" height="45" rx="4" fill="#e3f2fd" stroke="#2196F3" stroke-width="2" style="animation: fade-in-up 0.5s ease-out;"/>
                                    <!-- Calendar header -->
                                    <rect x="10" y="15" width="50" height="12" rx="4" fill="#2196F3" style="animation: fade-in-up 0.5s ease-out 0.1s both;"/>
                                    <!-- Calendar rings -->
                                    <circle cx="22" cy="15" r="3" fill="#1976D2" style="animation: pop-in 0.3s ease-out 0.3s both;"/>
                                    <circle cx="48" cy="15" r="3" fill="#1976D2" style="animation: pop-in 0.3s ease-out 0.3s both;"/>
                                    <!-- Checkmark -->
                                    <path d="M 25 35 L 32 42 L 45 29" stroke="#4CAF50" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round" style="animation: draw-line 0.8s ease-out 0.4s both;"/>
                                </svg>
                            </div>
                        </div>
                        <div style="margin-top: 12px; font-size: 13px; color: #1976D2; display: flex; align-items: center; gap: 4px;">
                            <span style="font-weight: 600;">Yƒ±llƒ±k</span> hakkƒ±nƒ±z
                        </div>
                    </div>

                    <!-- Kullanƒ±lan ƒ∞zin - Progress Ring -->
                    <div class="stat-card warning" style="position: relative; overflow: visible;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div class="stat-label">Kullanƒ±lan ƒ∞zin</div>
                                <div class="stat-value" id="usedLeave" style="font-size: 42px;">5</div>
                                <div class="stat-subtitle">G√ºn</div>
                            </div>
                            <div style="position: relative;">
                                <svg width="80" height="80" style="transform: rotate(-90deg);">
                                    <!-- Background circle -->
                                    <circle cx="40" cy="40" r="32" fill="none" stroke="#fff3cd" stroke-width="6" opacity="0.3"/>
                                    <!-- Progress circle (5/20 = 25%) -->
                                    <circle cx="40" cy="40" r="32" fill="none" stroke="#FFC107" stroke-width="6"
                                            stroke-dasharray="201" stroke-dashoffset="150"
                                            stroke-linecap="round"
                                            style="filter: drop-shadow(0 0 6px rgba(255, 193, 7, 0.5)); animation: fill-donut 1.5s ease-out;"/>
                                </svg>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                    <div style="font-size: 15px; font-weight: 700; color: #F57C00; line-height: 1;">25%</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 12px; height: 4px; background: rgba(255, 193, 7, 0.2); border-radius: 2px; overflow: hidden;">
                            <div style="height: 100%; width: 25%; background: linear-gradient(90deg, #FFC107, #F57C00); animation: progress-glow 2s ease-in-out infinite;"></div>
                        </div>
                    </div>

                    <!-- Kalan ƒ∞zin - Battery/Progress Bar -->
                    <div class="stat-card success" style="position: relative; overflow: visible;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div class="stat-label">Kalan ƒ∞zin</div>
                                <div class="stat-value" id="remainingLeave" style="font-size: 42px;">15</div>
                                <div class="stat-subtitle">G√ºn</div>
                            </div>
                            <div style="position: relative;">
                                <svg width="70" height="70" viewBox="0 0 70 70">
                                    <!-- Battery outline -->
                                    <rect x="12" y="22" width="45" height="26" rx="3" fill="none" stroke="#4CAF50" stroke-width="2.5" style="animation: fade-in-up 0.5s ease-out;"/>
                                    <!-- Battery tip -->
                                    <rect x="57" y="30" width="4" height="10" rx="1" fill="#4CAF50" style="animation: fade-in-up 0.5s ease-out 0.1s both;"/>
                                    <!-- Battery fill (75%) -->
                                    <rect x="15" y="25" width="33" height="20" rx="2" fill="url(#gradient-battery)" style="animation: fade-in-up 0.8s ease-out 0.2s both;"/>
                                    <defs>
                                        <linearGradient id="gradient-battery" x1="0%" y1="0%" x2="100%" y2="0%">
                                            <stop offset="0%" style="stop-color:#4CAF50;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#2E7D32;stop-opacity:1" />
                                        </linearGradient>
                                    </defs>
                                    <!-- Sparkle -->
                                    <path d="M 35 35 L 37 35 L 36 33 L 37 31 L 35 31 L 34 33 Z" fill="#FFF" opacity="0.8" style="animation: pop-in 0.4s ease-out 0.5s both;"/>
                                </svg>
                            </div>
                        </div>
                        <div style="margin-top: 12px; display: flex; gap: 4px; align-items: center; color: #2E7D32; font-size: 13px; font-weight: 600;">
                            <span style="font-size: 16px;">‚úì</span> %75 kalan
                        </div>
                    </div>

                    <!-- Bekleyen Talepler - Circular Progress -->
                    <div class="stat-card info" style="position: relative; overflow: visible;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div class="stat-label">Bekleyen Talepler</div>
                                <div class="stat-value" id="pendingRequests" style="font-size: 42px;">2</div>
                                <div class="stat-subtitle">Talep</div>
                            </div>
                            <div style="position: relative;">
                                <svg width="80" height="80" style="transform: rotate(-90deg);">
                                    <!-- Background circle -->
                                    <circle cx="40" cy="40" r="32" fill="none" stroke="#e3f2fd" stroke-width="6" opacity="0.3"/>
                                    <!-- Progress circle -->
                                    <circle cx="40" cy="40" r="32" fill="none" stroke="#2196F3" stroke-width="6"
                                            stroke-dasharray="201" stroke-dashoffset="160"
                                            stroke-linecap="round"
                                            style="filter: drop-shadow(0 0 6px rgba(33, 150, 243, 0.5)); animation: pulse-ring 2s ease-in-out infinite;"/>
                                </svg>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 18px; font-weight: 700; color: #1976D2;">‚è≥</div>
                            </div>
                        </div>
                        <div style="margin-top: 12px; font-size: 13px; color: #1976D2;">
                            <span style="font-weight: 600;">Onay</span> bekleniyor
                        </div>
                    </div>
                </div>

                <!-- Quick Actions & Calendar -->
                <div class="grid grid-cols-2 mb-5" style="gap: 20px;">
                    <!-- Hƒ±zlƒ± ƒ∞≈ülemler -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Hƒ±zlƒ± ƒ∞≈ülemler</h3>
                        </div>
                        <div class="card-body">
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <a href="yeni-talep.html" class="btn btn-primary w-full">
                                    ‚ûï Yeni ƒ∞zin Talebi
                                </a>
                                <a href="izinlerim.html" class="btn btn-outline-primary w-full">
                                    üìã ƒ∞zin Ge√ßmi≈üim
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Takvim: Yakla≈üan Tatiller ve ƒ∞zinler -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üìÖ Yakla≈üan Tatiller ve ƒ∞zinler</h3>
                        </div>
                        <div class="card-body" style="max-height: 280px; overflow-y: auto;">
                            <div id="upcomingCalendar" style="display: flex; flex-direction: column; gap: 10px;">
                                <!-- JavaScript ile doldurulacak -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Requests -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Son ƒ∞zin Taleplerim</h3>
                        <a href="izinlerim.html" class="btn btn-sm btn-ghost">T√ºm√ºn√º G√∂r</a>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>ƒ∞zin Tipi</th>
                                    <th>Ba≈ülangƒ±√ß</th>
                                    <th>Biti≈ü</th>
                                    <th>G√ºn</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody id="recentRequestsTable">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        Hen√ºz izin talebiniz bulunmuyor
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Y√ñNETƒ∞Cƒ∞ G√ñR√úN√úM√ú -->
            <div id="managerView" style="display: none;">
                <!-- Stats Grid with Visualizations -->
                <div class="grid grid-cols-4 mb-5">
                    <!-- Onay Bekleyen - Circular Progress -->
                    <div class="stat-card warning" style="position: relative; overflow: visible;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div class="stat-label">Onay Bekleyen</div>
                                <div class="stat-value" style="font-size: 42px;">8</div>
                                <div class="stat-subtitle">Talep</div>
                            </div>
                            <div style="position: relative;">
                                <svg width="80" height="80" style="transform: rotate(-90deg);">
                                    <!-- Background circle -->
                                    <circle cx="40" cy="40" r="32" fill="none" stroke="#fff3cd" stroke-width="6" opacity="0.3"/>
                                    <!-- Progress circle -->
                                    <circle cx="40" cy="40" r="32" fill="none" stroke="#FFC107" stroke-width="6"
                                            stroke-dasharray="201" stroke-dashoffset="140"
                                            stroke-linecap="round"
                                            style="filter: drop-shadow(0 0 6px rgba(255, 193, 7, 0.5)); animation: pulse-ring 2s ease-in-out infinite;"/>
                                </svg>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 18px; font-weight: 700; color: #F57C00;">‚è±</div>
                            </div>
                        </div>
                        <div style="margin-top: 12px; height: 4px; background: rgba(255, 193, 7, 0.2); border-radius: 2px; overflow: hidden;">
                            <div style="height: 100%; width: 30%; background: linear-gradient(90deg, #FFC107, #F57C00); animation: progress-glow 2s ease-in-out infinite;"></div>
                        </div>
                    </div>

                    <!-- Bu Ay Onaylanan - Trend Line -->
                    <div class="stat-card success" style="position: relative; overflow: visible;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div class="stat-label">Bu Ay Onaylanan</div>
                                <div class="stat-value" style="font-size: 42px;">24</div>
                                <div class="stat-subtitle">Talep</div>
                            </div>
                            <div>
                                <svg width="80" height="60" style="overflow: visible;">
                                    <!-- Grid lines -->
                                    <line x1="0" y1="50" x2="80" y2="50" stroke="#e8f5e9" stroke-width="1" opacity="0.5"/>
                                    <line x1="0" y1="30" x2="80" y2="30" stroke="#e8f5e9" stroke-width="1" opacity="0.5"/>
                                    <!-- Trend line -->
                                    <polyline points="0,45 15,40 30,35 45,28 60,20 75,10"
                                              fill="none" stroke="#4CAF50" stroke-width="3"
                                              stroke-linecap="round" stroke-linejoin="round"
                                              style="filter: drop-shadow(0 2px 4px rgba(76, 175, 80, 0.3)); animation: draw-line 2s ease-out;"/>
                                    <!-- Data points -->
                                    <circle cx="0" cy="45" r="3" fill="#4CAF50" style="animation: pop-in 0.5s ease-out 0.2s both;"/>
                                    <circle cx="15" cy="40" r="3" fill="#4CAF50" style="animation: pop-in 0.5s ease-out 0.4s both;"/>
                                    <circle cx="30" cy="35" r="3" fill="#4CAF50" style="animation: pop-in 0.5s ease-out 0.6s both;"/>
                                    <circle cx="45" cy="28" r="3" fill="#4CAF50" style="animation: pop-in 0.5s ease-out 0.8s both;"/>
                                    <circle cx="60" cy="20" r="3" fill="#4CAF50" style="animation: pop-in 0.5s ease-out 1s both;"/>
                                    <circle cx="75" cy="10" r="4" fill="#4CAF50" style="animation: pop-in 0.5s ease-out 1.2s both;"/>
                                </svg>
                            </div>
                        </div>
                        <div style="margin-top: 12px; display: flex; gap: 4px; align-items: center; color: #2E7D32; font-size: 13px; font-weight: 600;">
                            <span style="font-size: 16px;">‚Üó</span> +12% bu aydan fazla
                        </div>
                    </div>

                    <!-- ƒ∞zinli √áalƒ±≈üan - Donut Chart -->
                    <div class="stat-card info" style="position: relative; overflow: visible;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div class="stat-label">ƒ∞zinli √áalƒ±≈üan</div>
                                <div class="stat-value" style="font-size: 42px;">5</div>
                                <div class="stat-subtitle">Ki≈üi</div>
                            </div>
                            <div style="position: relative;">
                                <svg width="80" height="80" style="transform: rotate(-90deg);">
                                    <!-- Background -->
                                    <circle cx="40" cy="40" r="32" fill="none" stroke="#e3f2fd" stroke-width="8"/>
                                    <!-- Progress (5/42 = 11.9%) -->
                                    <circle cx="40" cy="40" r="32" fill="none" stroke="url(#gradient-info)" stroke-width="8"
                                            stroke-dasharray="201" stroke-dashoffset="177"
                                            stroke-linecap="round"
                                            style="filter: drop-shadow(0 0 6px rgba(33, 150, 243, 0.4)); animation: fill-donut 1.5s ease-out;"/>
                                    <defs>
                                        <linearGradient id="gradient-info" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#2196F3;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#1976D2;stop-opacity:1" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                    <div style="font-size: 16px; font-weight: 700; color: #1976D2; line-height: 1;">12%</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 12px; font-size: 13px; color: #1976D2;">
                            <span style="font-weight: 600;">37</span> √ßalƒ±≈üan aktif
                        </div>
                    </div>

                    <!-- Toplam √áalƒ±≈üan - People Grid -->
                    <div class="stat-card" style="position: relative; overflow: visible;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div class="stat-label">Toplam √áalƒ±≈üan</div>
                                <div class="stat-value" style="font-size: 42px;">42</div>
                                <div class="stat-subtitle">Ki≈üi</div>
                            </div>
                            <div style="position: relative;">
                                <div id="peopleGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; padding: 8px;">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 12px; display: flex; gap: 8px; font-size: 12px;">
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <div style="width: 8px; height: 8px; background: #4CAF50; border-radius: 50%;"></div>
                                <span style="color: #666;">37 Aktif</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <div style="width: 8px; height: 8px; background: #2196F3; border-radius: 50%;"></div>
                                <span style="color: #666;">5 ƒ∞zinli</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions & Calendar -->
                <div class="grid grid-cols-2 mb-5" style="gap: 20px;">
                    <!-- Hƒ±zlƒ± ƒ∞≈ülemler -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Hƒ±zlƒ± ƒ∞≈ülemler</h3>
                        </div>
                        <div class="card-body">
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <a href="yeni-talep.html" class="btn btn-primary w-full">
                                    ‚ûï Yeni ƒ∞zin Talebi
                                </a>
                                <a href="izinlerim.html" class="btn btn-outline-primary w-full">
                                    üìã ƒ∞zin Ge√ßmi≈üim
                                </a>
                                <a href="onay-yonetimi.html" class="btn btn-outline-primary w-full">
                                    ‚úì Onay Bekleyen Talepler
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Takvim: Yakla≈üan Tatiller ve ƒ∞zinler (Y√∂netici) -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üìÖ Yakla≈üan Tatiller ve ƒ∞zinler</h3>
                        </div>
                        <div class="card-body" style="max-height: 280px; overflow-y: auto;">
                            <div id="upcomingCalendarManager" style="display: flex; flex-direction: column; gap: 10px;">
                                <!-- JavaScript ile doldurulacak -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pending Approvals -->
                <div class="card mb-5">
                    <div class="card-header">
                        <h3 class="card-title">Onay Bekleyen Talepler</h3>
                        <span class="badge badge-warning">8 Talep</span>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>√áalƒ±≈üan</th>
                                    <th>ƒ∞zin Tipi</th>
                                    <th>Ba≈ülangƒ±√ß</th>
                                    <th>Biti≈ü</th>
                                    <th>G√ºn</th>
                                    <th>Talep Tarihi</th>
                                    <th>ƒ∞≈ülemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- JavaScript tarafƒ±ndan doldurulacak -->
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer">
                        <a href="onay-yonetimi.html" class="btn btn-primary">T√ºm Talepleri G√∂r√ºnt√ºle</a>
                    </div>
                </div>

                <!-- √áalƒ±≈üanlarƒ±n Kalan ƒ∞zinleri (Y√∂netici i√ßin) -->
                <div class="card" id="employeeLeaveBalanceCard" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">Departman ƒ∞zin Durumu</h3>
                        <p id="departmentName" style="margin: 4px 0 0 0; font-size: 13px; color: #6b7280; font-weight: 500;"></p>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                        <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">#</th>
                                        <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">√áalƒ±≈üan</th>
                                        <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Departman</th>
                                        <th style="padding: 12px; text-align: center; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Hak Edilen</th>
                                        <th style="padding: 12px; text-align: center; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Kullanƒ±lan</th>
                                        <th style="padding: 12px; text-align: center; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Kalan</th>
                                        <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Durum</th>
                                    </tr>
                                </thead>
                                <tbody id="employeeLeaveBalanceList">
                                    <!-- JavaScript ile doldurulacak -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Team Overview -->
                <div class="grid grid-cols-2">
                    <!-- En √áok Birikmi≈ü ƒ∞zni Olanlar (ƒ∞K i√ßin) -->
                    <div class="card" id="topAccumulatedLeaveCard" style="display: none;">
                        <div class="card-header">
                            <h3 class="card-title">üìä En √áok Birikmi≈ü ƒ∞zin (Top 10)</h3>
                        </div>
                        <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                            <div id="topAccumulatedLeaveList" style="display: flex; flex-direction: column; gap: 12px;">
                                <!-- JavaScript ile doldurulacak -->
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Bu Hafta ƒ∞zinli √áalƒ±≈üanlar</h3>
                        </div>
                        <div class="card-body">
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="width: 32px; height: 32px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600;">MD</div>
                                        <div>
                                            <div style="font-weight: 500; font-size: 14px;">Mehmet Demir</div>
                                            <div style="font-size: 12px; color: var(--text-tertiary);">05-08 Kasƒ±m</div>
                                        </div>
                                    </div>
                                    <span class="badge badge-success">Onaylandƒ±</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="width: 32px; height: 32px; background: var(--success); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600;">ES</div>
                                        <div>
                                            <div style="font-weight: 500; font-size: 14px;">Elif ≈ûahin</div>
                                            <div style="font-size: 12px; color: var(--text-tertiary);">06-07 Kasƒ±m</div>
                                        </div>
                                    </div>
                                    <span class="badge badge-success">Onaylandƒ±</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="width: 32px; height: 32px; background: var(--warning); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600;">CK</div>
                                        <div>
                                            <div style="font-weight: 500; font-size: 14px;">Can Kƒ±lƒ±√ß</div>
                                            <div style="font-size: 12px; color: var(--text-tertiary);">08-09 Kasƒ±m</div>
                                        </div>
                                    </div>
                                    <span class="badge badge-success">Onaylandƒ±</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Approve Modal -->
    <div id="approveModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: modalSlideIn 0.3s ease-out;" onclick="event.stopPropagation()">
            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 24px; border-radius: 16px 16px 0 0;">
                <h4 style="margin: 0; font-size: 20px; font-weight: 600;">‚úì ƒ∞zin Talebini Onayla</h4>
            </div>
            <div style="padding: 24px;">
                <div id="managerAssignmentOptions" style="display: none; margin-bottom: 20px; padding: 16px; background: #eff6ff; border-radius: 8px; border: 2px solid #3b82f6;">
                    <div style="font-weight: 600; color: #1e40af; margin-bottom: 12px; font-size: 14px;">Y√∂netici Onay Se√ßenekleri:</div>
                    <div>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="requiresAssignment" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-size: 14px; color: #1e3a8a; font-weight: 500;">Yerine g√∂revlendirme yapƒ±lmalƒ±</span>
                        </label>
                        <div style="margin-top: 6px; margin-left: 26px; font-size: 12px; color: #1e40af;">
                            Bu se√ßenek i≈üaretlenirse, talep M√º≈üteri ƒ∞li≈ükileri onayƒ±na g√∂nderilir.
                        </div>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; color: #1f2937; margin-bottom: 8px; font-size: 14px;">
                        Onay Notu (Opsiyonel):
                    </label>
                    <textarea id="approveComment" rows="4" style="width: 100%; padding: 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; font-family: inherit; resize: vertical; min-height: 100px; line-height: 1.6;" placeholder="ƒ∞sterseniz onay notu ekleyebilirsiniz..."></textarea>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="closeApproveModal()" style="padding: 12px 24px; border: none; border-radius: 8px; background: #e5e7eb; color: #1f2937; font-weight: 600; cursor: pointer; font-size: 14px;">ƒ∞ptal</button>
                    <button onclick="confirmApprove()" style="padding: 12px 24px; border: none; border-radius: 8px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-weight: 600; cursor: pointer; font-size: 14px; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);">Onayla</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reject Modal -->
    <div id="rejectModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: modalSlideIn 0.3s ease-out;" onclick="event.stopPropagation()">
            <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 24px; border-radius: 16px 16px 0 0;">
                <h4 style="margin: 0; font-size: 20px; font-weight: 600;">‚ùå ƒ∞zin Talebini Reddet</h4>
            </div>
            <div style="padding: 24px;">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; color: #1f2937; margin-bottom: 8px; font-size: 14px;">
                        <span id="rejectEmployeeName"></span> i√ßin red sebebini girin:
                    </label>
                    <textarea id="rejectReason" rows="6" style="width: 100%; padding: 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; font-family: inherit; resize: vertical; min-height: 120px; line-height: 1.6;" placeholder="Red sebebini detaylƒ± olarak a√ßƒ±klayƒ±n..."></textarea>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="closeRejectModal()" style="padding: 12px 24px; border: none; border-radius: 8px; background: #e5e7eb; color: #1f2937; font-weight: 600; cursor: pointer; font-size: 14px;">ƒ∞ptal</button>
                    <button onclick="confirmReject()" style="padding: 12px 24px; border: none; border-radius: 8px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; font-weight: 600; cursor: pointer; font-size: 14px; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);">Tamam</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Revise Modal -->
    <div id="reviseModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: modalSlideIn 0.3s ease-out;" onclick="event.stopPropagation()">
            <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 24px; border-radius: 16px 16px 0 0;">
                <h4 style="margin: 0; font-size: 20px; font-weight: 600;">üîÑ Revizyon Talebi</h4>
            </div>
            <div style="padding: 24px;">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; color: #1f2937; margin-bottom: 4px; font-size: 14px;">
                        <span id="reviseEmployeeName"></span> i√ßin revize notunu girin:
                    </label>
                    <div style="font-size: 13px; color: #6b7280; margin-bottom: 12px;">(√ñrn: Tarih deƒüi≈üikliƒüi, ek bilgi gerekli, vb.)</div>
                    <textarea id="reviseNote" rows="6" style="width: 100%; padding: 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; font-family: inherit; resize: vertical; min-height: 120px; line-height: 1.6;" placeholder="Revizyon gerektiren hususlarƒ± detaylƒ± olarak belirtin..."></textarea>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="closeReviseModal()" style="padding: 12px 24px; border: none; border-radius: 8px; background: #e5e7eb; color: #1f2937; font-weight: 600; cursor: pointer; font-size: 14px;">ƒ∞ptal</button>
                    <button onclick="confirmRevise()" style="padding: 12px 24px; border: none; border-radius: 8px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-weight: 600; cursor: pointer; font-size: 14px; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);">Tamam</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Dashboard Chart Animations */
        @keyframes pulse-ring {
            0%, 100% {
                stroke-dashoffset: 140;
                opacity: 1;
            }
            50% {
                stroke-dashoffset: 120;
                opacity: 0.8;
            }
        }

        @keyframes progress-glow {
            0%, 100% {
                box-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
            }
            50% {
                box-shadow: 0 0 20px rgba(255, 193, 7, 0.8);
            }
        }

        @keyframes draw-line {
            from {
                stroke-dasharray: 200;
                stroke-dashoffset: 200;
            }
            to {
                stroke-dasharray: 200;
                stroke-dashoffset: 0;
            }
        }

        @keyframes pop-in {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes fill-donut {
            from {
                stroke-dashoffset: 201;
            }
            to {
                stroke-dashoffset: 177;
            }
        }

        /* Tablo satƒ±r hover efekti */
        #employeeLeaveBalanceList tr:hover {
            background: #f9fafb;
            cursor: pointer;
        }

        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>

    <script src="js/app.js?v=3.6"></script>
    <script src="js/workflow-engine.js"></script>
    <script>
        // Load user data and show appropriate view
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        const userData = JSON.parse(localStorage.getItem(`userData_${currentUser.id}`) || '{}');

        if (currentUser.name) {
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = getRoleDisplayName(currentUser.role);
            document.getElementById('userAvatar').textContent = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();

            // Update navbar based on role
            updateNavbarForRole(currentUser.role);

            // Show appropriate dashboard view
            if (currentUser.role === 'employee') {
                document.getElementById('pageTitle').textContent = 'Dashboard - Personel';
                document.getElementById('pageSubtitle').textContent = 'ƒ∞zin bilgilerinizi ve taleplerini takip edin';
                document.getElementById('employeeView').style.display = 'block';
                loadEmployeeDashboard(userData);
            } else if (currentUser.role === 'manager' || currentUser.role === 'hr' || currentUser.role === 'operation' || currentUser.role === 'customerRelations') {
                // Rol bazlƒ± ba≈ülƒ±k
                if (currentUser.role === 'customerRelations') {
                    document.getElementById('pageTitle').textContent = 'Dashboard - M√º≈üteri ƒ∞li≈ükileri';
                    document.getElementById('pageSubtitle').textContent = 'G√∂revlendirme onaylarƒ± ve m√º≈üteri bilgilendirmelerini y√∂netin';
                } else {
                    document.getElementById('pageTitle').textContent = 'Dashboard - Y√∂netici';
                    document.getElementById('pageSubtitle').textContent = 'Ekibinizin izin durumlarƒ±nƒ± ve bekleyen talepleri g√∂r√ºnt√ºleyin';
                }

                document.getElementById('managerView').style.display = 'block';

                // Generate people grid
                generatePeopleGrid();

                // Load calendar for manager view (only holidays, no user-specific leaves)
                loadUpcomingCalendar([], 'upcomingCalendarManager');

                // Load pending approvals for manager
                loadManagerDashboard();
            }
        }

        function loadManagerDashboard() {
            const userRole = currentUser.role;

            console.log('üîç loadManagerDashboard() ba≈ülatƒ±ldƒ±');
            console.log('   User Role:', userRole);

            // Demo verileri otomatik y√ºkle (sadece ilk seferinde)
            const allRequests = WorkflowEngine.getAllRequests();
            if (allRequests.length === 0) {
                console.log('üì¶ Demo verileri y√ºkleniyor (ilk giri≈ü)...');
                App.generateSampleData();
            }

            // WorkflowEngine'den bekleyen talepleri al
            const pendingRequests = WorkflowEngine.getPendingRequestsForRole(userRole);

            console.log('   T√ºm talepler:', allRequests.length);
            console.log('   Bekleyen talepler:', pendingRequests.length);
            console.log('   Bekleyen talepler detayƒ±:', pendingRequests);

            // ƒ∞statistikleri g√ºncelle
            // 1. Onay Bekleyen (warning card)
            const pendingStatCards = document.querySelectorAll('#managerView .stat-card.warning .stat-value');
            if (pendingStatCards[0]) pendingStatCards[0].textContent = pendingRequests.length;

            // 2. Bu Ay Onaylanan (success card)
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const approvedThisMonth = allRequests.filter(r => {
                if (r.status !== 'approved') return false;
                const date = new Date(r.createdAt);
                return date.getMonth() === thisMonth && date.getFullYear() === thisYear;
            });
            const monthStats = document.querySelectorAll('#managerView .stat-card.success .stat-value');
            if (monthStats[0]) monthStats[0].textContent = approvedThisMonth.length;

            // 3. ƒ∞zinli √áalƒ±≈üan (info card) - ≈ûu anda izinde olan √ßalƒ±≈üanlar
            const today = new Date();
            today.setHours(0, 0, 0, 0); // G√ºn√ºn ba≈ülangƒ±cƒ±
            const employeesOnLeave = allRequests.filter(r => {
                if (r.status !== 'approved') return false;
                const startDate = new Date(r.startDate);
                const endDate = new Date(r.endDate);
                startDate.setHours(0, 0, 0, 0);
                endDate.setHours(0, 0, 0, 0);
                return today >= startDate && today <= endDate;
            });
            const onLeaveStats = document.querySelectorAll('#managerView .stat-card.info .stat-value');
            if (onLeaveStats[0]) onLeaveStats[0].textContent = employeesOnLeave.length;

            // ƒ∞zinli √ßalƒ±≈üan y√ºzdesini ve a√ßƒ±klamayƒ± g√ºncelle
            const totalEmployees = JSON.parse(localStorage.getItem('users') || '[]').filter(u => u.role === 'employee').length;
            const onLeavePercentage = totalEmployees > 0 ? Math.round((employeesOnLeave.length / totalEmployees) * 100) : 0;
            const activeEmployees = totalEmployees - employeesOnLeave.length;

            // Y√ºzdeyi g√ºncelle
            const percentageElement = document.querySelector('#managerView .stat-card.info div[style*="font-size: 16px"]');
            if (percentageElement) {
                percentageElement.textContent = onLeavePercentage + '%';
            }

            // Aktif √ßalƒ±≈üan sayƒ±sƒ±nƒ± g√ºncelle
            const activeEmployeesElement = document.querySelector('#managerView .stat-card.info div[style*="margin-top: 12px"] span');
            if (activeEmployeesElement) {
                activeEmployeesElement.textContent = activeEmployees;
            }

            // Progress bar'ƒ± g√ºncelle
            const progressCircle = document.querySelector('#managerView .stat-card.info circle[stroke-dashoffset]');
            if (progressCircle) {
                const circumference = 201;
                const offset = circumference - (circumference * onLeavePercentage / 100);
                progressCircle.setAttribute('stroke-dashoffset', offset);
            }

            // Onay bekleyen talepler tablosunu doldur
            loadPendingApprovalsTable(pendingRequests);

            // Role g√∂re √∂zel kartlarƒ± g√∂ster
            if (userRole === 'manager') {
                loadEmployeeLeaveBalance();
            } else if (userRole === 'hr') {
                loadTopAccumulatedLeave();
            }
        }

        function loadPendingApprovalsTable(pendingRequests) {
            const tableBody = document.querySelector('#managerView .table-container tbody');
            if (!tableBody) return;

            if (pendingRequests.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">
                            <div style="font-size: 32px; margin-bottom: 8px;">üì≠</div>
                            <div>Onay bekleyen talep bulunmuyor</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = pendingRequests.slice(0, 8).map(request => {
                const leaveTypeName = getLeaveTypeName(request.type);
                const createdDate = new Date(request.createdAt).toLocaleDateString('tr-TR');
                const currentStepLabel = request.workflow.steps.find(s => s.step === request.workflow.currentStep)?.label || 'Onay Bekliyor';

                // Get initials from name
                const initials = request.userName.split(' ').map(n => n[0]).join('').toUpperCase();

                // M√º≈üteri ƒ∞li≈ükileri i√ßin √∂zel render
                if (currentUser.role === 'customerRelations') {
                    const currentStepObj = request.workflow.steps.find(s => s.step === request.workflow.currentStep);
                    const requiresAssignment = currentStepObj?.requiresAssignment || false;
                    const hasServiceGap = request.noServiceGap || false;

                    // Firma bilgileri varsa g√∂ster
                    let companyInfo = '';
                    if (hasServiceGap && request.serviceCompany) {
                        companyInfo = `
                            <div style="font-size: 12px; color: #0ea5e9; margin-top: 4px;">
                                üè¢ ${request.serviceCompany} (${request.serviceDuration})
                            </div>
                        `;
                    }

                    return `
                        <tr style="background: ${hasServiceGap ? '#f0f9ff' : 'white'};">
                            <td>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="width: 32px; height: 32px; background: #0ea5e9; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600;">${initials}</div>
                                    <div>
                                        <div style="font-weight: 500;">${request.userName}</div>
                                        <div style="font-size: 12px; color: #6b7280;">${request.userDepartment}</div>
                                        ${request.projectLocation ? `<div style="font-size: 11px; color: #0ea5e9;">üìç ${request.projectLocation}</div>` : ''}
                                        ${companyInfo}
                                    </div>
                                </div>
                            </td>
                            <td>
                                ${leaveTypeName}
                                ${hasServiceGap ? '<div style="font-size: 11px; color: #0ea5e9; margin-top: 4px;">‚ö†Ô∏è Eksik Hizmet</div>' : ''}
                            </td>
                            <td>${new Date(request.startDate).toLocaleDateString('tr-TR')}</td>
                            <td>${new Date(request.endDate).toLocaleDateString('tr-TR')}</td>
                            <td><span class="badge badge-info">${request.days}</span></td>
                            <td>${createdDate}</td>
                            <td>
                                <div style="display: flex; flex-direction: column; gap: 6px;">
                                    ${requiresAssignment ? `
                                        <button class="btn btn-sm btn-success" onclick="handleCustomerRelationsApprove('${request.id}', true)" style="white-space: nowrap;">‚úì G√∂revlendirmeyi Onayla</button>
                                        <button class="btn btn-sm btn-danger" onclick="handleCustomerRelationsReject('${request.id}')" style="white-space: nowrap;">‚úó G√∂revlendirmeyi Reddet</button>
                                    ` : `
                                        <button class="btn btn-sm btn-success" onclick="handleCustomerRelationsApprove('${request.id}', false)">‚úì Onayla</button>
                                        <button class="btn btn-sm btn-danger" onclick="openRejectModal('${request.id}')">‚úó Reddet</button>
                                    `}
                                    ${hasServiceGap ? `<button class="btn btn-sm" onclick="openCustomerSelectionModal('${request.id}')" style="background: #0ea5e9; color: white; white-space: nowrap; font-size: 10px; padding: 6px 10px;">üìß Bilgilendirme Yapƒ±lacak M√º≈üterileri Se√ß</button>` : ''}
                                    <button class="btn btn-sm btn-secondary" onclick="viewDetails('${request.id}')" style="white-space: nowrap;">üìÑ Detay</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }

                // Diƒüer roller i√ßin standart render
                // Y√∂netici i√ßin departmanƒ± IT Departmanƒ± olarak g√∂ster
                const displayDepartment = userRole === 'manager' ? 'IT Departmanƒ±' : request.userDepartment;

                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 32px; height: 32px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600;">${initials}</div>
                                <div>
                                    <div style="font-weight: 500;">${request.userName}</div>
                                    <div style="font-size: 12px; color: #6b7280;">${displayDepartment}</div>
                                </div>
                            </div>
                        </td>
                        <td>${leaveTypeName}</td>
                        <td>${new Date(request.startDate).toLocaleDateString('tr-TR')}</td>
                        <td>${new Date(request.endDate).toLocaleDateString('tr-TR')}</td>
                        <td><span class="badge badge-info">${request.days}</span></td>
                        <td>${createdDate}</td>
                        <td>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-sm btn-success" onclick="openApproveModal('${request.id}')">‚úì Onayla</button>
                                <button class="btn btn-sm btn-danger" onclick="openRejectModal('${request.id}')">‚úó Reddet</button>
                                <button class="btn btn-sm btn-warning" onclick="openReviseModal('${request.id}')">üîÑ Revize</button>
                                <button class="btn btn-sm btn-secondary" onclick="viewDetails('${request.id}')">üìÑ Detay</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Badge sayƒ±sƒ±nƒ± g√ºncelle
            const badge = document.querySelector('#managerView .card-header .badge');
            if (badge) {
                badge.textContent = `${pendingRequests.length} Talep`;
            }
        }

        function getLeaveTypeName(type) {
            const types = {
                'annual': 'Yƒ±llƒ±k ƒ∞zin',
                'marriage': 'Evlilik ƒ∞zni',
                'birth': 'Doƒüum ƒ∞zni',
                'death': '√ñl√ºm ƒ∞zni',
                'excuse': 'Mazeret ƒ∞zni',
                'paternity': 'Babalƒ±k ƒ∞zni',
                'unpaid': '√úcretsiz ƒ∞zin',
                'advance': 'Avans ƒ∞zin',
                'education': 'Eƒüitim ƒ∞zni',
                'sickness': 'Hastalƒ±k ƒ∞zni',
                'adoption': 'Evlat Edinme ƒ∞zni'
            };
            return types[type] || type;
        }

        function generatePeopleGrid() {
            const peopleGrid = document.getElementById('peopleGrid');
            if (!peopleGrid) return;

            // Create 42 people dots (37 active green + 5 on leave blue)
            for (let i = 0; i < 42; i++) {
                const dot = document.createElement('div');
                // First 37 are active (green), last 5 are on leave (blue)
                const isOnLeave = i >= 37;
                const gradient = isOnLeave ?
                    'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)' :
                    'linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%)';
                const shadowColor = isOnLeave ? 'rgba(33, 150, 243, 0.3)' : 'rgba(76, 175, 80, 0.3)';

                dot.style.cssText = `
                    width: 8px;
                    height: 8px;
                    background: ${gradient};
                    border-radius: 50%;
                    animation: fade-in-up 0.3s ease-out ${i * 0.02}s both;
                    box-shadow: 0 1px 3px ${shadowColor};
                `;
                peopleGrid.appendChild(dot);
            }
        }

        function getRoleDisplayName(role) {
            const roles = {
                'employee': 'Personel',
                'manager': 'Y√∂netici',
                'hr': 'ƒ∞nsan Kaynaklarƒ±',
                'operation': 'Operasyon',
                'customerRelations': 'M√º≈üteri ƒ∞li≈ükileri'
            };
            return roles[role] || 'Kullanƒ±cƒ±';
        }

        function updateNavbarForRole(role) {
            const navbar = document.getElementById('navbarMenu');
            if (role === 'employee') {
                navbar.innerHTML = `
                    <a href="dashboard.html" class="nav-link active">Dashboard</a>
                    <a href="izinlerim.html" class="nav-link">ƒ∞zinlerim</a>
                    <a href="yeni-talep.html" class="nav-link">Yeni Talep</a>
                `;
            } else {
                navbar.innerHTML = `
                    <a href="dashboard.html" class="nav-link active">Dashboard</a>
                    <a href="onay-yonetimi.html" class="nav-link">Onay Bekleyenler</a>
                    <a href="tum-izinler.html" class="nav-link">T√ºm ƒ∞zinler</a>
                    <a href="raporlar.html" class="nav-link">Raporlar</a>
                `;
            }
        }

        function loadEmployeeDashboard(userData) {
            const balance = userData.leaveBalance || { earned: 0, used: 0, remaining: 0 };
            document.getElementById('earnedLeave').textContent = balance.earned;
            document.getElementById('usedLeave').textContent = balance.used;
            document.getElementById('remainingLeave').textContent = balance.remaining;

            const requests = userData.leaveRequests || [];
            document.getElementById('pendingRequests').textContent = requests.filter(r => r.status === 'pending').length;

            // Load recent requests table
            loadRecentRequestsTable(requests);

            // Load calendar with holidays and leaves
            loadUpcomingCalendar(requests);
        }

        function loadUpcomingCalendar(userRequests, containerId = 'upcomingCalendar') {
            const calendarDiv = document.getElementById(containerId);
            if (!calendarDiv) return;

            // 2025-2026 T√ºrkiye Resmi Tatilleri
            const publicHolidays = [
                // 2025 Tatilleri
                { date: '2025-01-01', name: 'Yƒ±lba≈üƒ±', days: 1 },
                { date: '2025-03-30', name: 'Ramazan Bayramƒ± 1. G√ºn', days: 3, endDate: '2025-04-01' },
                { date: '2025-04-23', name: 'Ulusal Egemenlik ve √áocuk Bayramƒ±', days: 1 },
                { date: '2025-05-01', name: 'Emek ve Dayanƒ±≈üma G√ºn√º', days: 1 },
                { date: '2025-05-19', name: 'Atat√ºrk\'√º Anma, Gen√ßlik ve Spor Bayramƒ±', days: 1 },
                { date: '2025-06-07', name: 'Kurban Bayramƒ± 1. G√ºn', days: 4, endDate: '2025-06-10' },
                { date: '2025-08-30', name: 'Zafer Bayramƒ±', days: 1 },
                { date: '2025-10-28', name: 'Cumhuriyet Bayramƒ± Arifesi', days: 1 },
                { date: '2025-10-29', name: 'Cumhuriyet Bayramƒ±', days: 1 },

                // 2026 Tatilleri
                { date: '2026-01-01', name: 'Yƒ±lba≈üƒ±', days: 1 },
                { date: '2026-03-20', name: 'Ramazan Bayramƒ± 1. G√ºn', days: 3, endDate: '2026-03-22' },
                { date: '2026-04-23', name: 'Ulusal Egemenlik ve √áocuk Bayramƒ±', days: 1 },
                { date: '2026-05-01', name: 'Emek ve Dayanƒ±≈üma G√ºn√º', days: 1 },
                { date: '2026-05-19', name: 'Atat√ºrk\'√º Anma, Gen√ßlik ve Spor Bayramƒ±', days: 1 },
                { date: '2026-05-27', name: 'Kurban Bayramƒ± 1. G√ºn', days: 4, endDate: '2026-05-30' },
                { date: '2026-08-30', name: 'Zafer Bayramƒ±', days: 1 },
                { date: '2026-10-28', name: 'Cumhuriyet Bayramƒ± Arifesi', days: 1 },
                { date: '2026-10-29', name: 'Cumhuriyet Bayramƒ±', days: 1 }
            ];

            // Kullanƒ±cƒ±nƒ±n yakla≈üan izinleri (onaylanmƒ±≈ü ve beklemede olanlar)
            const upcomingLeaves = userRequests
                .filter(r => r.status === 'approved' || r.status === 'pending')
                .filter(r => new Date(r.startDate) >= new Date())
                .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

            // Yakla≈üan resmi tatilleri filtrele (bug√ºnden sonraki 365 g√ºn - 1 yƒ±l)
            const today = new Date();
            const nextYear = new Date(today.getTime() + 365 * 24 * 60 * 60 * 1000);
            const upcomingHolidays = publicHolidays.filter(h => {
                const holidayDate = new Date(h.date);
                return holidayDate >= today && holidayDate <= nextYear;
            });

            // T√ºm etkinlikleri birle≈ütir
            const allEvents = [];

            // Tatilleri ekle
            upcomingHolidays.forEach(holiday => {
                allEvents.push({
                    date: new Date(holiday.date),
                    type: 'holiday',
                    name: holiday.name,
                    days: holiday.days,
                    endDate: holiday.endDate ? new Date(holiday.endDate) : null
                });
            });

            // ƒ∞zinleri ekle
            upcomingLeaves.forEach(leave => {
                const typeNames = {
                    annual: 'Yƒ±llƒ±k ƒ∞zin',
                    excuse: 'Mazeret ƒ∞zni',
                    sickness: 'Hastalƒ±k ƒ∞zni',
                    marriage: 'Evlilik ƒ∞zni',
                    birth: 'Doƒüum ƒ∞zni',
                    death: '√ñl√ºm ƒ∞zni',
                    paternity: 'Babalƒ±k ƒ∞zni',
                    unpaid: '√úcretsiz ƒ∞zin',
                    advance: 'Avans ƒ∞zin',
                    education: 'Eƒüitim ƒ∞zni',
                    adoption: 'Evlat Edinme ƒ∞zni'
                };

                allEvents.push({
                    date: new Date(leave.startDate),
                    type: 'leave',
                    name: typeNames[leave.type] || leave.type,
                    status: leave.status,
                    days: leave.days,
                    endDate: new Date(leave.endDate),
                    description: leave.description
                });
            });

            // Tarihe g√∂re sƒ±rala
            allEvents.sort((a, b) => a.date - b.date);

            // HTML olu≈ütur
            if (allEvents.length === 0) {
                calendarDiv.innerHTML = '<p style="text-align: center; color: var(--text-tertiary); padding: 20px; font-size: 14px;">Yakla≈üan tatil veya izin bulunmuyor</p>';
                return;
            }

            // ƒ∞lk 10 etkinliƒüi g√∂ster
            const displayEvents = allEvents.slice(0, 10);

            calendarDiv.innerHTML = displayEvents.map(event => {
                if (event.type === 'holiday') {
                    // Resmi Tatil
                    const dateStr = event.endDate
                        ? `${event.date.toLocaleDateString('tr-TR')} - ${event.endDate.toLocaleDateString('tr-TR')}`
                        : event.date.toLocaleDateString('tr-TR');

                    return `
                        <div style="padding: 12px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: var(--radius-md); border-left: 4px solid #2196F3;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; font-size: 13px; color: #1976D2; margin-bottom: 2px;">üéâ ${event.name}</div>
                                    <div style="font-size: 12px; color: #455A64;">${dateStr} ‚Ä¢ ${event.days} G√ºn</div>
                                </div>
                                <span style="background: #2196F3; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">TATIL</span>
                            </div>
                        </div>
                    `;
                } else {
                    // Kullanƒ±cƒ± ƒ∞zni
                    const badge = event.status === 'approved' ? 'success' : 'warning';
                    const statusText = event.status === 'approved' ? 'Onaylandƒ±' : 'Beklemede';
                    const bgColor = event.status === 'approved' ? '#e8f5e9' : '#fff8e1';
                    const borderColor = event.status === 'approved' ? '#4CAF50' : '#FFC107';
                    const textColor = event.status === 'approved' ? '#2E7D32' : '#F57C00';

                    const dateStr = `${event.date.toLocaleDateString('tr-TR')} - ${event.endDate.toLocaleDateString('tr-TR')}`;

                    return `
                        <div style="padding: 12px; background: ${bgColor}; border-radius: var(--radius-md); border-left: 4px solid ${borderColor};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <div style="font-weight: 600; font-size: 13px; color: ${textColor};">‚úàÔ∏è ${event.name}</div>
                                <span class="badge badge-${badge}" style="font-size: 10px;">${statusText}</span>
                            </div>
                            <div style="font-size: 12px; color: #616161;">${dateStr}</div>
                            <div style="font-size: 11px; color: #757575; margin-top: 2px;">${event.days} ‚Ä¢ ${event.description || 'ƒ∞zin'}</div>
                        </div>
                    `;
                }
            }).join('');
        }

        function loadRecentRequestsTable(requests) {
            const tbody = document.getElementById('recentRequestsTable');

            if (!requests || requests.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            Hen√ºz izin talebiniz bulunmuyor
                        </td>
                    </tr>
                `;
                return;
            }

            const typeNames = {
                annual: 'Yƒ±llƒ±k ƒ∞zin',
                excuse: 'Mazeret ƒ∞zni',
                sickness: 'Hastalƒ±k ƒ∞zni',
                marriage: 'Evlilik ƒ∞zni',
                birth: 'Doƒüum ƒ∞zni',
                death: '√ñl√ºm ƒ∞zni',
                paternity: 'Babalƒ±k ƒ∞zni',
                unpaid: '√úcretsiz ƒ∞zin',
                advance: 'Avans ƒ∞zin',
                education: 'Eƒüitim ƒ∞zni',
                adoption: 'Evlat Edinme ƒ∞zni'
            };

            const statusNames = {
                pending: 'Beklemede',
                approved: 'Onaylandƒ±',
                rejected: 'Reddedildi'
            };

            const statusBadges = {
                pending: 'warning',
                approved: 'success',
                rejected: 'danger'
            };

            // Show most recent 5 requests
            const recentRequests = requests.slice(0, 5);

            tbody.innerHTML = recentRequests.map(req => {
                const reqType = typeNames[req.type] || req.type;
                const reqStatus = statusNames[req.status] || req.status;
                const badge = statusBadges[req.status] || 'secondary';

                return `
                    <tr>
                        <td>${new Date(req.createdAt).toLocaleDateString('tr-TR')}</td>
                        <td>${reqType}</td>
                        <td>${new Date(req.startDate).toLocaleDateString('tr-TR')}</td>
                        <td>${new Date(req.endDate).toLocaleDateString('tr-TR')}</td>
                        <td>${req.days}</td>
                        <td><span class="badge badge-${badge}">${reqStatus}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // Show calendar view with upcoming leaves
        function showCalendarView() {
            const requests = userData.leaveRequests || [];

            // Filter approved and pending leaves
            const upcomingLeaves = requests
                .filter(r => r.status === 'approved' || r.status === 'pending')
                .filter(r => new Date(r.startDate) >= new Date())
                .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

            const typeNames = {
                annual: 'Yƒ±llƒ±k ƒ∞zin',
                excuse: 'Mazeret ƒ∞zni',
                sickness: 'Hastalƒ±k ƒ∞zni',
                marriage: 'Evlilik ƒ∞zni',
                birth: 'Doƒüum ƒ∞zni',
                death: '√ñl√ºm ƒ∞zni',
                paternity: 'Babalƒ±k ƒ∞zni',
                unpaid: '√úcretsiz ƒ∞zin',
                advance: 'Avans ƒ∞zin',
                education: 'Eƒüitim ƒ∞zni',
                adoption: 'Evlat Edinme ƒ∞zni'
            };

            const statusBadges = {
                pending: 'warning',
                approved: 'success'
            };

            const statusNames = {
                pending: 'Beklemede',
                approved: 'Onaylandƒ±'
            };

            let content = '';

            if (upcomingLeaves.length === 0) {
                content = '<p style="text-align: center; color: var(--text-tertiary); padding: 20px;">Yakla≈üan izniniz bulunmuyor</p>';
            } else {
                content = '<div style="display: flex; flex-direction: column; gap: 12px;">';
                upcomingLeaves.forEach(leave => {
                    const badge = statusBadges[leave.status];
                    const status = statusNames[leave.status];
                    const type = typeNames[leave.type] || leave.type;

                    content += `
                        <div style="padding: 16px; background: var(--gray-50); border-radius: var(--radius-md); border-left: 4px solid var(--${badge === 'success' ? 'success' : 'warning'});">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div>
                                    <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">${type}</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">
                                        ${new Date(leave.startDate).toLocaleDateString('tr-TR')} - ${new Date(leave.endDate).toLocaleDateString('tr-TR')}
                                    </div>
                                </div>
                                <span class="badge badge-${badge}">${status}</span>
                            </div>
                            <div style="font-size: 13px; color: var(--text-tertiary);">
                                ${leave.days} ‚Ä¢ ${leave.description || 'A√ßƒ±klama yok'}
                            </div>
                        </div>
                    `;
                });
                content += '</div>';
            }

            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                padding: 20px;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: var(--radius-xl); max-width: 600px; width: 100%; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: var(--shadow-2xl);">
                    <div style="padding: 24px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h2 style="font-size: 20px; font-weight: 700; margin: 0; color: var(--text-primary);">üìÖ Yakla≈üan ƒ∞zinlerim</h2>
                            <p style="font-size: 14px; color: var(--text-tertiary); margin: 4px 0 0 0;">Onaylanmƒ±≈ü ve bekleyen izinleriniz</p>
                        </div>
                        <button onclick="this.closest('[style*=fixed]').remove()" style="width: 32px; height: 32px; border: none; background: var(--gray-100); border-radius: var(--radius-md); cursor: pointer; font-size: 20px; line-height: 1; color: var(--text-secondary); transition: all 0.2s;">√ó</button>
                    </div>
                    <div style="padding: 24px; overflow-y: auto; flex: 1;">
                        ${content}
                    </div>
                    <div style="padding: 16px 24px; border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end; gap: 8px;">
                        <button onclick="this.closest('[style*=fixed]').remove()" class="btn btn-secondary">Kapat</button>
                        <a href="izinlerim.html" class="btn btn-primary">T√ºm ƒ∞zinleri G√∂r</a>
                    </div>
                </div>
            `;

            // Close on background click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            document.body.appendChild(modal);
        }

        // Global variables for modal context
        let currentRequestId = null;
        let currentRequestRow = null;

        // Manager Request Functions - Modal Based (Using WorkflowEngine)

        // Approve Modal Functions
        function openApproveModal(requestId) {
            currentRequestId = requestId;
            document.getElementById('approveComment').value = '';

            // Y√∂netici ise ve SAHA √ßalƒ±≈üanƒ± i√ßin g√∂revlendirme se√ßeneƒüini g√∂ster
            const request = WorkflowEngine.getRequest(requestId);
            const managerAssignmentOptions = document.getElementById('managerAssignmentOptions');
            if (currentUser.role === 'manager' && request && request.workLocation === 'saha') {
                managerAssignmentOptions.style.display = 'block';
                document.getElementById('requiresAssignment').checked = false;
            } else {
                managerAssignmentOptions.style.display = 'none';
            }

            document.getElementById('approveModal').style.display = 'flex';
        }

        function closeApproveModal() {
            currentRequestId = null;
            document.getElementById('approveModal').style.display = 'none';
        }

        function confirmApprove() {
            const comment = document.getElementById('approveComment').value;
            const requiresAssignment = currentUser.role === 'manager' ? document.getElementById('requiresAssignment').checked : false;

            const success = WorkflowEngine.approveRequest(
                currentRequestId,
                currentUser.name,
                currentUser.role,
                comment,
                false, // wetSignatureVerified (sadece ƒ∞K i√ßin)
                requiresAssignment // Y√∂netici g√∂revlendirme gerektiriyor mu?
            );

            if (success) {
                App.showNotification('Talep ba≈üarƒ±yla onaylandƒ±!', 'success');
                closeApproveModal();
                loadManagerDashboard();
            }
        }

        // Reject Modal Functions
        function openRejectModal(requestId) {
            currentRequestId = requestId;
            document.getElementById('rejectReason').value = '';
            document.getElementById('rejectModal').style.display = 'flex';
            setTimeout(() => document.getElementById('rejectReason').focus(), 100);
        }

        function closeRejectModal() {
            currentRequestId = null;
            document.getElementById('rejectModal').style.display = 'none';
        }

        function confirmReject() {
            const reason = document.getElementById('rejectReason').value.trim();

            if (!reason) {
                App.showNotification('Reddetme nedeni zorunludur!', 'error');
                return;
            }

            const success = WorkflowEngine.rejectRequest(
                currentRequestId,
                currentUser.name,
                currentUser.role,
                reason
            );

            if (success) {
                App.showNotification('Talep reddedildi.', 'success');
                closeRejectModal();
                loadManagerDashboard();
            }
        }

        // Revise Modal Functions
        function openReviseModal(requestId) {
            currentRequestId = requestId;
            document.getElementById('reviseNote').value = '';
            document.getElementById('reviseModal').style.display = 'flex';
            setTimeout(() => document.getElementById('reviseNote').focus(), 100);
        }

        function closeReviseModal() {
            currentRequestId = null;
            document.getElementById('reviseModal').style.display = 'none';
        }

        function confirmRevise() {
            const note = document.getElementById('reviseNote').value.trim();

            if (!note) {
                App.showNotification('Revize a√ßƒ±klamasƒ± zorunludur!', 'error');
                return;
            }

            const success = WorkflowEngine.reviseRequest(
                currentRequestId,
                currentUser.name,
                currentUser.role,
                note
            );

            if (success) {
                App.showNotification('Talep revize i√ßin geri g√∂nderildi.', 'success');
                closeReviseModal();
                loadManagerDashboard();
            }
        }

        // View Details Function
        function viewDetails(requestId) {
            // Get all requests and find the specific request
            const allRequests = WorkflowEngine.getAllRequests();
            const request = allRequests.find(r => r.id === requestId);

            if (!request) {
                App.showNotification('Talep bulunamadƒ±!', 'error');
                return;
            }

            const leaveTypeName = getLeaveTypeName(request.type);
            const history = request.workflow.history || [];

            // Render workflow steps
            const workflowStepsHTML = request.workflow.steps.map((step, index) => {
                const isCompleted = step.status === 'completed' || step.status === 'approved';
                const isPending = step.status === 'pending';
                const isWaiting = step.status === 'waiting';

                let icon, bgColor, textColor, statusText;
                if (isCompleted) {
                    icon = '‚úì';
                    bgColor = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                    textColor = '#059669';
                    statusText = 'Tamamlandƒ±';
                } else if (isPending) {
                    icon = '‚è±';
                    bgColor = 'linear-gradient(135deg, #FFC107 0%, #F57C00 100%)';
                    textColor = '#F57C00';
                    statusText = 'ƒ∞≈ülemde';
                } else {
                    icon = index + 1;
                    bgColor = '#e5e7eb';
                    textColor = '#9ca3af';
                    statusText = 'Beklemede';
                }

                // Evrak kontrol√º durumu
                let documentInfo = '';
                if (step.requiresDocument && step.step === 'hr') {
                    if (request.documents && request.documents.length > 0) {
                        if (step.documentVerified) {
                            documentInfo = `<div style="margin-top: 6px; font-size: 12px; color: #10b981;">‚úì Evrak kontrol edildi (${request.documents.length} dosya)</div>`;
                        } else if (isPending) {
                            documentInfo = `<div style="margin-top: 6px; font-size: 12px; color: #FFC107;">üìÑ Evrak kontrol√º bekleniyor (${request.documents.length} dosya)</div>`;
                        }
                    } else if (isPending) {
                        documentInfo = `<div style="margin-top: 6px; font-size: 12px; color: #ef4444;">‚ö†Ô∏è Evrak y√ºklenmemi≈ü!</div>`;
                    }
                }

                // Islak imza kontrol√º durumu (sadece ƒ∞K adƒ±mƒ± i√ßin)
                let wetSignatureInfo = '';
                if (step.step === 'hr') {
                    if (step.wetSignatureVerified) {
                        const verifiedAt = step.wetSignatureVerifiedAt ? new Date(step.wetSignatureVerifiedAt).toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';
                        wetSignatureInfo = `<div style="margin-top: 6px; font-size: 12px; color: #10b981;">‚úì Islak imza kontrol edildi${verifiedAt ? ' (' + verifiedAt + ')' : ''}</div>`;
                    } else if (isPending) {
                        wetSignatureInfo = `<div style="margin-top: 6px; font-size: 12px; color: #FFC107;">‚úçÔ∏è Islak imza kontrol√º bekleniyor</div>`;
                    }
                }

                return `
                    <div style="position: relative; margin-bottom: ${index < request.workflow.steps.length - 1 ? '24px' : '0'};">
                        ${index < request.workflow.steps.length - 1 ? `
                            <div style="position: absolute; left: 19px; top: 40px; bottom: -24px; width: 2px; background: ${isCompleted ? '#10b981' : '#e5e7eb'}; z-index: 0;"></div>
                        ` : ''}
                        <div style="display: flex; align-items: start; gap: 16px;">
                            <div style="width: 40px; height: 40px; background: ${bgColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; box-shadow: ${isCompleted || isPending ? '0 4px 12px rgba(16, 185, 129, 0.3)' : 'none'}; z-index: 1; flex-shrink: 0;">${icon}</div>
                            <div style="flex: 1; padding-top: 4px; opacity: ${isWaiting ? '0.5' : '1'};">
                                <div style="font-weight: 600; color: ${isWaiting ? '#6b7280' : '#1f2937'}; margin-bottom: 4px;">${step.label}</div>
                                <div style="font-size: 13px; color: #6b7280;">${statusText}</div>
                                ${documentInfo}
                                ${wetSignatureInfo}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Render history
            const historyHTML = history.map(h => {
                const timestamp = new Date(h.timestamp).toLocaleString('tr-TR');
                let actionText = '', bgColor = '', borderColor = '';

                if (h.action === 'created') {
                    actionText = 'üìù Talep Olu≈üturuldu';
                    bgColor = '#f0fdf4';
                    borderColor = '#10b981';
                } else if (h.action === 'approved') {
                    actionText = '‚úÖ Onaylandƒ±';
                    bgColor = '#f0fdf4';
                    borderColor = '#10b981';
                } else if (h.action === 'rejected') {
                    actionText = '‚ùå Reddedildi';
                    bgColor = '#fee2e2';
                    borderColor = '#ef4444';
                } else if (h.action === 'revised') {
                    actionText = 'üîÑ Revize ƒ∞stendi';
                    bgColor = '#fff8e1';
                    borderColor = '#FFC107';
                }

                return `
                    <div style="margin-bottom: 16px; padding: 12px; background: ${bgColor}; border-left: 3px solid ${borderColor}; border-radius: 6px;">
                        <div style="font-weight: 600; margin-bottom: 4px;">${actionText}</div>
                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 6px;">
                            ${h.by} ‚Ä¢ ${timestamp}
                        </div>
                        ${h.comment ? `<div style="font-size: 13px; padding: 8px; background: white; border-radius: 4px; margin-top: 6px;">${h.comment}</div>` : ''}
                    </div>
                `;
            }).join('');

            // Create detail modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                padding: 20px;
                backdrop-filter: blur(4px);
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 650px; width: 100%; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); animation: modalSlideIn 0.3s ease-out;" onclick="event.stopPropagation()">
                    <div style="padding: 28px 32px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: relative;">
                        <button onclick="this.closest('[style*=fixed]').remove()" style="position: absolute; top: 20px; right: 20px; width: 36px; height: 36px; border: none; background: rgba(255, 255, 255, 0.2); border-radius: 50%; cursor: pointer; font-size: 24px; line-height: 1; color: white; transition: all 0.2s; backdrop-filter: blur(10px);">√ó</button>
                        <h2 style="font-size: 24px; font-weight: 700; margin: 0; color: white;">üìã ƒ∞zin Talebi Detayƒ±</h2>
                        <p style="font-size: 15px; color: rgba(255, 255, 255, 0.9); margin: 8px 0 0 0; font-weight: 500;">${request.userName} ‚Ä¢ ${request.userDepartment}</p>
                    </div>

                    <div style="padding: 32px; overflow-y: auto; flex: 1; background: #f8f9fa;">
                        <!-- Talep Bilgileri -->
                        <div style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                            <h3 style="font-size: 14px; font-weight: 700; color: #667eea; margin: 0 0 16px 0; text-transform: uppercase; letter-spacing: 0.5px;">üìã Talep Bilgileri</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 16px;">
                                <div>
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 6px; font-weight: 500;">Personel</div>
                                    <div style="font-size: 15px; font-weight: 600; color: #212529;">${request.userName}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 6px; font-weight: 500;">Departman</div>
                                    <div style="font-size: 15px; font-weight: 600; color: #212529;">${request.userDepartment}</div>
                                </div>
                            </div>
                            ${(() => {
                                // √áalƒ±≈üanƒ±n kalan izin bilgisini al
                                const userData = JSON.parse(localStorage.getItem('userData_' + request.userId) || '{}');
                                const leaveBalance = userData.leaveBalance || null;
                                if (leaveBalance) {
                                    return `
                                    <div style="background: linear-gradient(135deg, #10b98115 0%, #059f6915 100%); padding: 16px; border-radius: 10px; border-left: 4px solid #10b981; margin-bottom: 16px;">
                                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 8px; font-weight: 600;">√áalƒ±≈üanƒ±n ƒ∞zin Durumu</div>
                                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                                            <div style="text-align: center;">
                                                <div style="font-size: 11px; color: #6c757d; margin-bottom: 4px;">Hak Edilen</div>
                                                <div style="font-size: 18px; font-weight: 700; color: #2196F3;">${leaveBalance.earned || 0}</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 11px; color: #6c757d; margin-bottom: 4px;">Kullanƒ±lan</div>
                                                <div style="font-size: 18px; font-weight: 700; color: #FFC107;">${leaveBalance.used || 0}</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 11px; color: #6c757d; margin-bottom: 4px;">Kalan</div>
                                                <div style="font-size: 18px; font-weight: 700; color: #10b981;">${leaveBalance.remaining || 0}</div>
                                            </div>
                                        </div>
                                    </div>
                                    `;
                                }
                                return '';
                            })()}
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); padding: 16px; border-radius: 10px; border-left: 4px solid #667eea;">
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 6px; font-weight: 500;">ƒ∞zin Tipi</div>
                                    <div style="font-size: 16px; font-weight: 700; color: #667eea;">${leaveTypeName}</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #20c99715 0%, #10b98115 100%); padding: 16px; border-radius: 10px; border-left: 4px solid #20c997;">
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 6px; font-weight: 500;">Toplam S√ºre</div>
                                    <div style="font-size: 16px; font-weight: 700; color: #20c997;">${request.days}</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 16px;">
                                <div>
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 6px; font-weight: 500;">Ba≈ülangƒ±√ß</div>
                                    <div style="font-size: 15px; font-weight: 600; color: #212529;">${new Date(request.startDate).toLocaleDateString('tr-TR')}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 6px; font-weight: 500;">Biti≈ü</div>
                                    <div style="font-size: 15px; font-weight: 600; color: #212529;">${new Date(request.endDate).toLocaleDateString('tr-TR')}</div>
                                </div>
                            </div>
                            ${request.description ? `
                            <div style="margin-top: 16px;">
                                <div style="font-size: 12px; color: #6c757d; margin-bottom: 6px; font-weight: 500;">A√ßƒ±klama</div>
                                <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 14px; color: #495057;">${request.description}</div>
                            </div>
                            ` : ''}
                            ${request.documents && request.documents.length > 0 ? `
                            <div style="margin-top: 16px;">
                                <div style="font-size: 12px; color: #6c757d; margin-bottom: 8px; font-weight: 500;">Y√ºklenen Belgeler</div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${request.documents.map((doc, idx) => `
                                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e5e7eb;">
                                            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                                <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px;">üìÑ</div>
                                                <div>
                                                    <div style="font-size: 14px; font-weight: 600; color: #212529;">${doc.name}</div>
                                                    <div style="font-size: 12px; color: #6c757d;">${(doc.size / 1024).toFixed(2)} KB</div>
                                                </div>
                                            </div>
                                            <a href="${doc.data}" download="${doc.name}" style="padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 6px; text-decoration: none; font-size: 13px; font-weight: 600; transition: all 0.2s;">ƒ∞ndir</a>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                        </div>

                        ${request.workflow.isFieldWorker ? `
                        <div style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                            <h3 style="font-size: 14px; font-weight: 700; color: #667eea; margin: 0 0 16px 0; text-transform: uppercase; letter-spacing: 0.5px;">üèóÔ∏è Saha Bilgileri</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                ${request.projectLocation ? `
                                <div>
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 6px; font-weight: 500;">Proje/Lokasyon</div>
                                    <div style="font-size: 15px; font-weight: 600; color: #212529;">${request.projectLocation}</div>
                                </div>
                                ` : ''}
                                ${request.projectLeader ? `
                                <div>
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 6px; font-weight: 500;">Proje Lideri</div>
                                    <div style="font-size: 15px; font-weight: 600; color: #212529;">${request.projectLeader}</div>
                                </div>
                                ` : ''}
                                <div>
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 6px; font-weight: 500;">Yerine G√∂revlendirme</div>
                                    <div style="font-size: 15px; font-weight: 600; color: #212529;">${request.needReplacement ? 'Evet' : 'Hayƒ±r'}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 6px; font-weight: 500;">Mƒ∞L Bilgilendirilsin</div>
                                    <div style="font-size: 15px; font-weight: 600; color: #212529;">${request.notifyMIL ? 'Evet' : 'Hayƒ±r'}</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        <!-- ƒ∞≈ü Akƒ±≈üƒ± -->
                        <div style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                            <h3 style="font-size: 14px; font-weight: 700; color: #667eea; margin: 0 0 20px 0; text-transform: uppercase; letter-spacing: 0.5px;">üîÑ Onay S√ºreci</h3>
                            ${workflowStepsHTML}
                        </div>

                        <!-- Talep Ge√ßmi≈üi -->
                        <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                            <h3 style="font-size: 14px; font-weight: 700; color: #667eea; margin: 0 0 16px 0; text-transform: uppercase; letter-spacing: 0.5px;">üìú Talep Ge√ßmi≈üi</h3>
                            ${historyHTML || '<div style="text-align: center; color: #6b7280; padding: 20px;">Hen√ºz ge√ßmi≈ü yok</div>'}
                        </div>
                    </div>

                    <div style="padding: 20px 32px; background: white; border-top: 1px solid #e9ecef; display: flex; justify-content: flex-end; gap: 12px;">
                        <button onclick="this.closest('[style*=fixed]').remove()" class="btn btn-secondary">Kapat</button>
                    </div>
                </div>
            `;

            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            document.body.appendChild(modal);
        }

        // Close modals on backdrop click
        document.getElementById('approveModal').addEventListener('click', function(e) {
            if (e.target === this) closeApproveModal();
        });

        document.getElementById('rejectModal').addEventListener('click', function(e) {
            if (e.target === this) closeRejectModal();
        });

        document.getElementById('reviseModal').addEventListener('click', function(e) {
            if (e.target === this) closeReviseModal();
        });

        // Close modals on ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeApproveModal();
                closeRejectModal();
                closeReviseModal();
            }
        });

        function showManagerRequestDetail(employeeName, department, leaveType, startDate, endDate, days, description) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                padding: 20px;
                backdrop-filter: blur(4px);
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 650px; width: 100%; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); animation: modalSlideIn 0.3s ease-out;">
                    <!-- Header -->
                    <div style="padding: 28px 32px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: relative;">
                        <button onclick="this.closest('[style*=fixed]').remove()" style="position: absolute; top: 20px; right: 20px; width: 36px; height: 36px; border: none; background: rgba(255, 255, 255, 0.2); border-radius: 50%; cursor: pointer; font-size: 24px; line-height: 1; color: white; transition: all 0.2s; backdrop-filter: blur(10px);" onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">√ó</button>
                        <h2 style="font-size: 24px; font-weight: 700; margin: 0; color: white;">üìã ƒ∞zin Talebi Detayƒ±</h2>
                        <p style="font-size: 15px; color: rgba(255, 255, 255, 0.9); margin: 8px 0 0 0; font-weight: 500;">${employeeName} ‚Ä¢ ${department}</p>
                    </div>

                    <!-- Body -->
                    <div style="padding: 32px; overflow-y: auto; flex: 1; background: #f8f9fa;">
                        <!-- √áalƒ±≈üan Bilgileri -->
                        <div style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                            <h3 style="font-size: 14px; font-weight: 700; color: #667eea; margin: 0 0 16px 0; text-transform: uppercase; letter-spacing: 0.5px;">üë§ √áalƒ±≈üan Bilgileri</h3>
                            <div class="grid grid-cols-2" style="gap: 20px;">
                                <div>
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 6px; font-weight: 500;">Ad Soyad</div>
                                    <div style="font-size: 16px; font-weight: 600; color: #212529;">${employeeName}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 6px; font-weight: 500;">Departman</div>
                                    <div style="font-size: 16px; font-weight: 600; color: #212529;">${department}</div>
                                </div>
                            </div>
                        </div>

                        <!-- ƒ∞zin Detaylarƒ± -->
                        <div style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                            <h3 style="font-size: 14px; font-weight: 700; color: #667eea; margin: 0 0 16px 0; text-transform: uppercase; letter-spacing: 0.5px;">üìÖ ƒ∞zin Detaylarƒ±</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); padding: 16px; border-radius: 10px; border-left: 4px solid #667eea;">
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 6px; font-weight: 500;">ƒ∞zin Tipi</div>
                                    <div style="font-size: 16px; font-weight: 700; color: #667eea;">${leaveType}</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #20c99715 0%, #10b98115 100%); padding: 16px; border-radius: 10px; border-left: 4px solid #20c997;">
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 6px; font-weight: 500;">Toplam S√ºre</div>
                                    <div style="font-size: 16px; font-weight: 700; color: #20c997;">${days}</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2" style="gap: 20px;">
                                <div>
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 6px; font-weight: 500;">üóì Ba≈ülangƒ±√ß Tarihi</div>
                                    <div style="font-size: 15px; font-weight: 600; color: #212529; background: #f8f9fa; padding: 10px 12px; border-radius: 8px;">${startDate}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 6px; font-weight: 500;">üèÅ Biti≈ü Tarihi</div>
                                    <div style="font-size: 15px; font-weight: 600; color: #212529; background: #f8f9fa; padding: 10px 12px; border-radius: 8px;">${endDate}</div>
                                </div>
                            </div>
                        </div>

                        <!-- A√ßƒ±klama -->
                        <div style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                            <h3 style="font-size: 14px; font-weight: 700; color: #667eea; margin: 0 0 12px 0; text-transform: uppercase; letter-spacing: 0.5px;">üí¨ A√ßƒ±klama</h3>
                            <div style="padding: 20px; background: #f8f9fa; border-radius: 10px; font-size: 15px; line-height: 1.8; color: #495057; min-height: 100px;">${description || 'A√ßƒ±klama eklenmedi.'}</div>
                        </div>

                        <!-- ƒ∞≈ü Akƒ±≈üƒ± Timeline -->
                        <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                            <h3 style="font-size: 14px; font-weight: 700; color: #667eea; margin: 0 0 20px 0; text-transform: uppercase; letter-spacing: 0.5px;">üîÑ ƒ∞≈ü Akƒ±≈üƒ±</h3>
                            <div style="position: relative;">
                                <!-- Timeline Line -->
                                <div style="position: absolute; left: 20px; top: 0; bottom: 0; width: 2px; background: linear-gradient(180deg, #10b981 0%, #FFC107 50%, #e5e7eb 100%);"></div>

                                <!-- Timeline Items -->
                                <div style="position: relative; margin-bottom: 24px;">
                                    <div style="display: flex; align-items: start; gap: 16px;">
                                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); z-index: 1;">‚úì</div>
                                        <div style="flex: 1; padding-top: 4px;">
                                            <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">Talep Olu≈üturuldu</div>
                                            <div style="font-size: 13px; color: #6b7280;">${employeeName} tarafƒ±ndan ‚Ä¢ 03.11.2025 14:30</div>
                                            <div style="margin-top: 8px; padding: 12px; background: #f0fdf4; border-left: 3px solid #10b981; border-radius: 6px; font-size: 14px; color: #059669;">Yƒ±llƒ±k izin talebi olu≈üturuldu</div>
                                        </div>
                                    </div>
                                </div>

                                <div style="position: relative; margin-bottom: 24px;">
                                    <div style="display: flex; align-items: start; gap: 16px;">
                                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #FFC107 0%, #F57C00 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3); z-index: 1;">‚è±</div>
                                        <div style="flex: 1; padding-top: 4px;">
                                            <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">Onay Bekliyor</div>
                                            <div style="font-size: 13px; color: #6b7280;">Mesul M√ºd√ºr onayƒ± bekleniyor</div>
                                            <div style="margin-top: 8px; padding: 12px; background: #fff8e1; border-left: 3px solid #FFC107; border-radius: 6px; font-size: 14px; color: #F57C00;">Sizin onayƒ±nƒ±zƒ± bekliyor</div>
                                        </div>
                                    </div>
                                </div>

                                <div style="position: relative; margin-bottom: 24px;">
                                    <div style="display: flex; align-items: start; gap: 16px;">
                                        <div style="width: 40px; height: 40px; background: #e5e7eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #9ca3af; font-weight: bold; z-index: 1;">3</div>
                                        <div style="flex: 1; padding-top: 4px; opacity: 0.5;">
                                            <div style="font-weight: 600; color: #6b7280; margin-bottom: 4px;">ƒ∞K Onayƒ±</div>
                                            <div style="font-size: 13px; color: #9ca3af;">Beklemede</div>
                                        </div>
                                    </div>
                                </div>

                                <div style="position: relative;">
                                    <div style="display: flex; align-items: start; gap: 16px;">
                                        <div style="width: 40px; height: 40px; background: #e5e7eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #9ca3af; font-weight: bold; z-index: 1;">4</div>
                                        <div style="flex: 1; padding-top: 4px; opacity: 0.5;">
                                            <div style="font-weight: 600; color: #6b7280; margin-bottom: 4px;">ƒ∞zin Kullanƒ±mƒ±</div>
                                            <div style="font-size: 13px; color: #9ca3af;">Beklemede</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div style="padding: 20px 32px; background: white; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; gap: 12px;">
                        <button onclick="this.closest('[style*=fixed]').remove()" class="btn btn-secondary" style="flex: 1;">Kapat</button>
                        <button onclick="window.location.href='onay-yonetimi.html'" class="btn btn-primary" style="flex: 1;">Onay Sayfasƒ±na Git</button>
                    </div>
                </div>

                <style>
                    @keyframes modalSlideIn {
                        from {
                            opacity: 0;
                            transform: translateY(-20px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                </style>
            `;

            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.style.animation = 'fadeOut 0.2s ease-out';
                    setTimeout(() => modal.remove(), 200);
                }
            });

            document.body.appendChild(modal);
        }

        // Y√∂netici i√ßin: Ekip √ºyelerinin kalan izinlerini g√∂ster
        function loadEmployeeLeaveBalance() {
            console.log('üîç loadEmployeeLeaveBalance() √ßaƒürƒ±ldƒ±');
            const card = document.getElementById('employeeLeaveBalanceCard');
            const list = document.getElementById('employeeLeaveBalanceList');
            const departmentNameEl = document.getElementById('departmentName');

            console.log('   Card element:', card);
            console.log('   List element:', list);

            if (!card || !list) {
                console.log('‚ùå Card veya list bulunamadƒ±!');
                return;
            }

            // currentUser'ƒ± global scope'tan al
            console.log('   Global currentUser:', currentUser);
            console.log('   currentUser.department:', currentUser.department);

            // Mevcut kullanƒ±cƒ±nƒ±n departmanƒ±nƒ± al
            const currentUserId = localStorage.getItem('currentUserId');
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userFromUsers = users.find(u => u.id === currentUserId);

            console.log('   Current User ID:', currentUserId);
            console.log('   User from users array:', userFromUsers);

            if (!currentUser) {
                console.log('‚ùå Current user bulunamadƒ±!');
                return;
            }

            // Departman adƒ±nƒ± g√∂ster
            if (departmentNameEl) {
                departmentNameEl.textContent = `${currentUser.department} - T√ºm √áalƒ±≈üanlar`;
            }

            // Sadece aynƒ± departmandaki √ßalƒ±≈üanlarƒ± al
            const employees = users.filter(u => u.role === 'employee' && u.department === currentUser.department);
            console.log('   Departman:', currentUser.department);
            console.log('   Aynƒ± departmandaki √ßalƒ±≈üanlar:', employees.length);

            // Her √ßalƒ±≈üan i√ßin izin bakiyesini al
            const employeesWithBalance = employees.map(emp => {
                const userData = JSON.parse(localStorage.getItem(`userData_${emp.id}`) || '{}');
                return {
                    ...emp,
                    leaveBalance: userData.leaveBalance || { earned: 0, used: 0, remaining: 0 }
                };
            });

            // Kalan izine g√∂re sƒ±rala (azdan √ßoƒüa) - T√úM √ßalƒ±≈üanlarƒ± g√∂ster
            employeesWithBalance.sort((a, b) => a.leaveBalance.remaining - b.leaveBalance.remaining);

            console.log('   ƒ∞zin bakiyesi olan √ßalƒ±≈üanlar:', employeesWithBalance.length);

            if (employeesWithBalance.length === 0) {
                console.log('‚ö†Ô∏è G√∂sterilecek √ßalƒ±≈üan yok');
                list.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #6b7280; padding: 40px;">Bu departmanda √ßalƒ±≈üan bulunamadƒ±</td></tr>';
                card.style.display = 'block';
                return;
            }

            console.log('‚úÖ Tablo olu≈üturuluyor...');

            list.innerHTML = employeesWithBalance.map((emp, index) => {
                const initials = emp.name.split(' ').map(n => n[0]).join('');
                const percentage = (emp.leaveBalance.used / emp.leaveBalance.earned) * 100;
                const remainingPercentage = (emp.leaveBalance.remaining / emp.leaveBalance.earned) * 100;

                // Renk ve durum belirleme (kalan izne g√∂re)
                let statusColor = '#10b981'; // ye≈üil
                let statusBg = '#d1fae5';
                let statusText = 'ƒ∞yi';
                if (remainingPercentage < 25) {
                    statusColor = '#ef4444'; // kƒ±rmƒ±zƒ±
                    statusBg = '#fee2e2';
                    statusText = 'Kritik';
                } else if (remainingPercentage < 50) {
                    statusColor = '#f59e0b'; // turuncu
                    statusBg = '#fef3c7';
                    statusText = 'Dikkat';
                }

                return `
                    <tr style="border-bottom: 1px solid #e5e7eb; transition: background 0.2s;">
                        <td style="padding: 16px; font-weight: 600; color: #6b7280;">${index + 1}</td>
                        <td style="padding: 16px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 13px; font-weight: 600;">${initials}</div>
                                <div>
                                    <div style="font-weight: 600; font-size: 14px; color: #1f2937;">${emp.name}</div>
                                    <div style="font-size: 12px; color: #6b7280;">${emp.email || ''}</div>
                                </div>
                            </div>
                        </td>
                        <td style="padding: 16px; font-weight: 500; font-size: 13px; color: #4b5563;">
                            <div style="background: #f3f4f6; padding: 6px 12px; border-radius: 6px; display: inline-block;">${emp.department}</div>
                        </td>
                        <td style="padding: 16px; text-align: center; font-weight: 600; font-size: 14px; color: #2196F3;">${emp.leaveBalance.earned}</td>
                        <td style="padding: 16px; text-align: center; font-weight: 600; font-size: 14px; color: #f59e0b;">${emp.leaveBalance.used}</td>
                        <td style="padding: 16px; text-align: center; font-weight: 700; font-size: 16px; color: ${statusColor};">${emp.leaveBalance.remaining}</td>
                        <td style="padding: 16px;">
                            <div style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: ${statusBg}; border-radius: 6px;">
                                <div style="width: 8px; height: 8px; background: ${statusColor}; border-radius: 50%;"></div>
                                <span style="font-size: 12px; font-weight: 600; color: ${statusColor};">${statusText}</span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            console.log('‚úÖ Tablo HTML olu≈üturuldu, kart g√∂steriliyor');
            card.style.display = 'block';
        }

        // ƒ∞K i√ßin: En √ßok birikmi≈ü izni olan top 10 √ßalƒ±≈üanƒ± g√∂ster
        function loadTopAccumulatedLeave() {
            const card = document.getElementById('topAccumulatedLeaveCard');
            const list = document.getElementById('topAccumulatedLeaveList');

            if (!card || !list) return;

            // T√ºm kullanƒ±cƒ±larƒ± al
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const employees = users.filter(u => u.role === 'employee');

            // Her √ßalƒ±≈üan i√ßin izin bakiyesini al
            const employeesWithBalance = employees.map(emp => {
                const userData = JSON.parse(localStorage.getItem(`userData_${emp.id}`) || '{}');
                return {
                    ...emp,
                    leaveBalance: userData.leaveBalance || { earned: 0, used: 0, remaining: 0 }
                };
            }).filter(emp => emp.leaveBalance.remaining > 0);

            // Kalan izine g√∂re sƒ±rala (√ßoktan aza) ve ilk 10'u al
            employeesWithBalance.sort((a, b) => b.leaveBalance.remaining - a.leaveBalance.remaining);
            const top10 = employeesWithBalance.slice(0, 10);

            if (top10.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 20px;">Veri bulunamadƒ±</div>';
                card.style.display = 'block';
                return;
            }

            list.innerHTML = top10.map((emp, index) => {
                const initials = emp.name.split(' ').map(n => n[0]).join('');
                const percentage = (emp.leaveBalance.used / emp.leaveBalance.earned) * 100;
                const remainingPercentage = (emp.leaveBalance.remaining / emp.leaveBalance.earned) * 100;

                // Sƒ±ralama rengi
                let rankBg = '#ef4444';
                let rankBorder = '#dc2626';
                if (index < 3) {
                    rankBg = '#ef4444'; // Top 3 kƒ±rmƒ±zƒ±
                    rankBorder = '#dc2626';
                } else if (index < 7) {
                    rankBg = '#f59e0b'; // 4-7 turuncu
                    rankBorder = '#d97706';
                } else {
                    rankBg = '#FFC107'; // 8-10 sarƒ±
                    rankBorder = '#F57C00';
                }

                return `
                    <div style="padding: 12px; background: white; border-radius: 8px; border: 2px solid ${rankBorder}; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 0; right: 0; background: ${rankBg}; color: white; padding: 4px 12px; border-bottom-left-radius: 8px; font-size: 12px; font-weight: 700;">
                            #${index + 1}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-right: 40px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 40px; height: 40px; background: ${rankBg}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 13px; font-weight: 700; border: 2px solid ${rankBorder};">${initials}</div>
                                <div>
                                    <div style="font-weight: 600; font-size: 14px; color: #1f2937;">${emp.name}</div>
                                    <div style="font-size: 12px; color: #6b7280;">${emp.department}</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 700; font-size: 20px; color: ${rankBg};">${emp.leaveBalance.remaining}</div>
                                <div style="font-size: 11px; color: #6b7280; font-weight: 600;">G√úN KALDI</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 10px;">
                            <div style="text-align: center; padding: 8px; background: rgba(33, 150, 243, 0.1); border-radius: 6px; border: 1px solid rgba(33, 150, 243, 0.2);">
                                <div style="font-size: 10px; color: #6b7280; margin-bottom: 2px; font-weight: 600;">HAK EDƒ∞LEN</div>
                                <div style="font-size: 16px; font-weight: 700; color: #2196F3;">${emp.leaveBalance.earned}</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: rgba(245, 158, 11, 0.1); border-radius: 6px; border: 1px solid rgba(245, 158, 11, 0.2);">
                                <div style="font-size: 10px; color: #6b7280; margin-bottom: 2px; font-weight: 600;">KULLANILAN</div>
                                <div style="font-size: 16px; font-weight: 700; color: #f59e0b;">${emp.leaveBalance.used}</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; border: 1px solid rgba(239, 68, 68, 0.2);">
                                <div style="font-size: 10px; color: #6b7280; margin-bottom: 2px; font-weight: 600;">Bƒ∞Rƒ∞KMƒ∞≈û</div>
                                <div style="font-size: 16px; font-weight: 700; color: ${rankBg};">${emp.leaveBalance.remaining}</div>
                            </div>
                        </div>
                        <div style="height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin-top: 10px;">
                            <div style="height: 100%; width: ${percentage}%; background: linear-gradient(90deg, ${rankBg}, ${rankBorder}); transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                `;
            }).join('');

            card.style.display = 'block';
        }

        // M√º≈üteri ƒ∞li≈ükileri hƒ±zlƒ± onay/red fonksiyonlarƒ±
        let currentCustomerRequestId = null;
        let selectedCustomers = [];

        function handleCustomerRelationsApprove(requestId, isAssignment) {
            const request = WorkflowEngine.getRequest(requestId);
            if (!request) return;

            // Se√ßili m√º≈üteriler varsa kullan
            const sendCustomerNotification = selectedCustomers.length > 0;

            const success = WorkflowEngine.approveCustomerRelationsRequest(
                requestId,
                currentUser.name,
                isAssignment ? 'G√∂revlendirme onaylandƒ±' : 'Onaylandƒ±',
                isAssignment ? true : null,
                sendCustomerNotification
            );

            if (success) {
                // Se√ßili m√º≈üterileri talep nesnesine kaydet
                if (sendCustomerNotification && selectedCustomers.length > 0) {
                    const updatedRequest = WorkflowEngine.getRequest(requestId);
                    updatedRequest.notifiedCustomers = selectedCustomers;
                    WorkflowEngine.saveRequest(updatedRequest);
                }

                const message = isAssignment ?
                    'G√∂revlendirme onaylandƒ± ve talep ƒ∞K\'ya g√∂nderildi!' :
                    'Talep ba≈üarƒ±yla onaylandƒ±!';

                if (sendCustomerNotification) {
                    App.showNotification(message + ` (${selectedCustomers.length} m√º≈üteri bilgilendirildi)`, 'success');
                } else {
                    App.showNotification(message, 'success');
                }

                selectedCustomers = [];
                loadManagerDashboard();
            }
        }

        function handleCustomerRelationsReject(requestId) {
            const reason = prompt('G√∂revlendirme red sebebini girin:');
            if (!reason || reason.trim() === '') {
                App.showNotification('Red sebebi zorunludur!', 'error');
                return;
            }

            const success = WorkflowEngine.rejectCustomerRelationsRequest(
                requestId,
                currentUser.name,
                reason,
                false
            );

            if (success) {
                App.showNotification('G√∂revlendirme reddedildi, talep iptal edildi!', 'error');
                selectedCustomers = [];
                loadManagerDashboard();
            }
        }

        function openCustomerSelectionModal(requestId) {
            currentCustomerRequestId = requestId;
            const request = WorkflowEngine.getRequest(requestId);
            if (!request) return;

            // Modal olu≈ütur
            const modal = document.createElement('div');
            modal.id = 'customerSelectionModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(4px);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease-out;
            `;

            // M√º≈üteri listesi (√∂rnek)
            const customers = [
                { id: 'cust1', name: 'Ankara √úniversitesi Hastanesi', contact: 'info@ankara.edu.tr' },
                { id: 'cust2', name: 'ƒ∞stanbul Saƒülƒ±k Merkezi', contact: 'info@istanbulsm.com.tr' },
                { id: 'cust3', name: 'ƒ∞zmir Devlet Hastanesi', contact: 'iletisim@izmirdh.gov.tr' },
                { id: 'cust4', name: 'Bursa √ñzel Hastane', contact: 'info@bursaozel.com.tr' },
                { id: 'cust5', name: 'Antalya Medikal Center', contact: 'info@antalyamc.com' }
            ];

            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 600px; width: 90%; max-height: 85vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: modalSlideIn 0.3s ease-out;" onclick="event.stopPropagation()">
                    <div style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white; padding: 24px; border-radius: 16px 16px 0 0;">
                        <h4 style="margin: 0; font-size: 20px; font-weight: 600;">üìß M√º≈üteri Se√ßimi</h4>
                        <p style="margin: 8px 0 0 0; font-size: 14px; opacity: 0.9;">${request.userName} - ${request.projectLocation}</p>
                    </div>
                    <div style="padding: 24px; max-height: 60vh; overflow-y: auto;">
                        <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0ea5e9;">
                            <div style="font-weight: 600; color: #0c4a6e; margin-bottom: 4px;">Bilgilendirme yapƒ±lacak m√º≈üterileri se√ßin</div>
                            <div style="font-size: 13px; color: #075985;">Se√ßili m√º≈üterilere izin bildirimi g√∂nderilecektir.</div>
                        </div>
                        <div id="customerList">
                            ${customers.map(customer => `
                                <label style="display: flex; align-items: start; gap: 12px; padding: 16px; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#0ea5e9'; this.style.background='#f0f9ff'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">
                                    <input type="checkbox" value="${customer.id}" style="margin-top: 4px; width: 18px; height: 18px; cursor: pointer;" onchange="updateCustomerSelection()">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">${customer.name}</div>
                                        <div style="font-size: 13px; color: #6b7280;">üìß ${customer.contact}</div>
                                    </div>
                                </label>
                            `).join('')}
                        </div>
                        <div id="selectionSummary" style="margin-top: 16px; padding: 12px; background: #ecfdf5; border-radius: 8px; border-left: 4px solid #10b981; display: none;">
                            <span style="font-weight: 600; color: #065f46;">Se√ßili: <span id="selectedCount">0</span> m√º≈üteri</span>
                        </div>
                    </div>
                    <div style="padding: 20px 24px; background: #f9fafb; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; gap: 12px;">
                        <button onclick="closeCustomerSelectionModal()" style="flex: 1; padding: 12px 24px; border: none; border-radius: 8px; background: #e5e7eb; color: #1f2937; font-weight: 600; cursor: pointer; font-size: 14px;">ƒ∞ptal</button>
                        <button onclick="confirmCustomerSelection()" style="flex: 1; padding: 12px 24px; border: none; border-radius: 8px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-weight: 600; cursor: pointer; font-size: 14px; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);">Onayla ve Bildir</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Modal dƒ±≈üƒ±na tƒ±klayƒ±nca kapat
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeCustomerSelectionModal();
                }
            });
        }

        function updateCustomerSelection() {
            const checkboxes = document.querySelectorAll('#customerList input[type="checkbox"]:checked');
            const count = checkboxes.length;
            const summary = document.getElementById('selectionSummary');
            const countSpan = document.getElementById('selectedCount');

            if (count > 0) {
                summary.style.display = 'block';
                countSpan.textContent = count;
            } else {
                summary.style.display = 'none';
            }
        }

        function closeCustomerSelectionModal() {
            const modal = document.getElementById('customerSelectionModal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => modal.remove(), 300);
            }
            currentCustomerRequestId = null;
        }

        function confirmCustomerSelection() {
            const checkboxes = document.querySelectorAll('#customerList input[type="checkbox"]:checked');
            selectedCustomers = Array.from(checkboxes).map(cb => {
                const label = cb.closest('label');
                const name = label.querySelector('div > div:first-child').textContent;
                const email = label.querySelector('div > div:last-child').textContent.replace('üìß ', '');
                return { id: cb.value, name, email };
            });

            if (selectedCustomers.length === 0) {
                App.showNotification('L√ºtfen en az bir m√º≈üteri se√ßin!', 'warning');
                return;
            }

            closeCustomerSelectionModal();

            // Onay butonuna otomatik bas
            if (currentCustomerRequestId) {
                const request = WorkflowEngine.getRequest(currentCustomerRequestId);
                const currentStepObj = request?.workflow?.steps.find(s => s.step === request.workflow.currentStep);
                const requiresAssignment = currentStepObj?.requiresAssignment || false;

                handleCustomerRelationsApprove(currentCustomerRequestId, requiresAssignment);
            }
        }
    </script>
</body>
</html>