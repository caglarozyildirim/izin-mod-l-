<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yeni ƒ∞zin Talebi - Tez Medikal</title>
    <link rel="stylesheet" href="css/design-system.css">
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        /* Flatpickr √∂zel stiller */
        .flatpickr-calendar {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .flatpickr-day.holiday {
            color: #dc2626 !important;
            font-weight: bold;
            background: #fee2e2 !important;
        }
        .flatpickr-day.weekend {
            color: #9ca3af !important;
            background: #f3f4f6 !important;
        }
        .flatpickr-day.selected {
            background: #3b82f6 !important;
            border-color: #3b82f6 !important;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <div style="width: 40px; height: 40px; background: var(--primary); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">TM</div>
            <span>Tez Medikal</span>
        </div>
        <div class="navbar-menu">
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="izinlerim.html" class="nav-link">ƒ∞zinlerim</a>
            <a href="yeni-talep.html" class="nav-link active">Yeni Talep</a>
        </div>
        <div class="navbar-user">
            <div class="user-info">
                <div class="user-name" id="userName">-</div>
                <div class="user-role" id="userRole">-</div>
            </div>
            <div class="user-avatar" id="userAvatar">-</div>
            <button class="btn btn-ghost btn-sm" data-action="logout">√áƒ±kƒ±≈ü</button>
        </div>
    </nav>

    <main class="main-content">
        <div class="container-fluid" style="max-width: 1600px; margin: 0 auto;">
            <div class="page-header">
                <h1 class="page-title">Yeni ƒ∞zin Talebi</h1>
                <p class="page-subtitle">ƒ∞zin talebinizi olu≈üturun</p>
            </div>

            <!-- ƒ∞zin Bakiyesi Bar -->
            <div class="grid grid-cols-3 mb-5">
                <!-- Hak Edilen ƒ∞zin - Calendar Icon -->
                <div class="stat-card" style="position: relative; overflow: visible;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div class="stat-label">Hak Edilen ƒ∞zin</div>
                            <div class="stat-value" id="earnedBalance" style="font-size: 42px;">20</div>
                            <div class="stat-subtitle">G√ºn</div>
                        </div>
                        <div style="position: relative;">
                            <svg width="70" height="70" viewBox="0 0 70 70" style="overflow: visible;">
                                <!-- Calendar base -->
                                <rect x="10" y="15" width="50" height="45" rx="4" fill="#e3f2fd" stroke="#2196F3" stroke-width="2" style="animation: fade-in-up 0.5s ease-out;"/>
                                <!-- Calendar header -->
                                <rect x="10" y="15" width="50" height="12" rx="4" fill="#2196F3" style="animation: fade-in-up 0.5s ease-out 0.1s both;"/>
                                <!-- Calendar rings -->
                                <circle cx="22" cy="15" r="3" fill="#1976D2" style="animation: pop-in 0.3s ease-out 0.3s both;"/>
                                <circle cx="48" cy="15" r="3" fill="#1976D2" style="animation: pop-in 0.3s ease-out 0.3s both;"/>
                                <!-- Checkmark -->
                                <path d="M 25 35 L 32 42 L 45 29" stroke="#4CAF50" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round" style="animation: draw-line 0.8s ease-out 0.4s both;"/>
                            </svg>
                        </div>
                    </div>
                    <div style="margin-top: 12px; font-size: 13px; color: #1976D2; display: flex; align-items: center; gap: 4px;">
                        <span style="font-weight: 600;">Yƒ±llƒ±k</span> hakkƒ±nƒ±z
                    </div>
                </div>

                <!-- Kullanƒ±lan ƒ∞zin - Progress Ring -->
                <div class="stat-card warning" style="position: relative; overflow: visible;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div class="stat-label">Kullanƒ±lan ƒ∞zin</div>
                            <div class="stat-value" id="usedBalance" style="font-size: 42px;">5</div>
                            <div class="stat-subtitle">G√ºn</div>
                        </div>
                        <div style="position: relative;">
                            <svg width="80" height="80" style="transform: rotate(-90deg);">
                                <!-- Background circle -->
                                <circle cx="40" cy="40" r="32" fill="none" stroke="#fff3cd" stroke-width="6" opacity="0.3"/>
                                <!-- Progress circle (5/20 = 25%) -->
                                <circle id="usedProgressCircle" cx="40" cy="40" r="32" fill="none" stroke="#FFC107" stroke-width="6"
                                        stroke-dasharray="201" stroke-dashoffset="150"
                                        stroke-linecap="round"
                                        style="filter: drop-shadow(0 0 6px rgba(255, 193, 7, 0.5)); animation: fill-donut 1.5s ease-out;"/>
                            </svg>
                            <div id="usedPercentage" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                <div style="font-size: 15px; font-weight: 700; color: #F57C00; line-height: 1;">25%</div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 12px; height: 4px; background: rgba(255, 193, 7, 0.2); border-radius: 2px; overflow: hidden;">
                        <div id="usedProgressBar" style="height: 100%; width: 25%; background: linear-gradient(90deg, #FFC107, #F57C00); animation: progress-glow 2s ease-in-out infinite;"></div>
                    </div>
                </div>

                <!-- Kalan ƒ∞zin - Battery/Progress Bar -->
                <div class="stat-card success" style="position: relative; overflow: visible;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div class="stat-label">Kalan ƒ∞zin</div>
                            <div class="stat-value" id="remainingBalance" style="font-size: 42px;">15</div>
                            <div class="stat-subtitle">G√ºn</div>
                        </div>
                        <div style="position: relative;">
                            <svg width="70" height="70" viewBox="0 0 70 70">
                                <!-- Battery outline -->
                                <rect x="12" y="22" width="45" height="26" rx="3" fill="none" stroke="#4CAF50" stroke-width="2.5" style="animation: fade-in-up 0.5s ease-out;"/>
                                <!-- Battery tip -->
                                <rect x="57" y="30" width="4" height="10" rx="1" fill="#4CAF50" style="animation: fade-in-up 0.5s ease-out 0.1s both;"/>
                                <!-- Battery fill (75%) -->
                                <rect id="batteryFill" x="15" y="25" width="33" height="20" rx="2" fill="url(#gradient-battery)" style="animation: fade-in-up 0.8s ease-out 0.2s both;"/>
                                <defs>
                                    <linearGradient id="gradient-battery" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" style="stop-color:#4CAF50;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#2E7D32;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <!-- Sparkle -->
                                <path d="M 35 35 L 37 35 L 36 33 L 37 31 L 35 31 L 34 33 Z" fill="#FFF" opacity="0.8" style="animation: pop-in 0.4s ease-out 0.5s both;"/>
                            </svg>
                        </div>
                    </div>
                    <div id="remainingPercentage" style="margin-top: 12px; display: flex; gap: 4px; align-items: center; color: #2E7D32; font-size: 13px; font-weight: 600;">
                        <span style="font-size: 16px;">‚úì</span> %75 kalan
                    </div>
                </div>
            </div>

            <form id="leaveRequestForm">
                <!-- ƒ∞ki S√ºtun Layout -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(600px, 1fr)); gap: 24px; margin-bottom: 24px;">
                    <!-- Sol: Personel Bilgileri -->
                    <div class="card" style="border: none; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); border-radius: 16px; overflow: hidden;">
                        <div class="card-header" style="background: linear-gradient(135deg, #4B9F8E 0%, #3a8070 100%); padding: 20px 24px; border: none;">
                            <h3 class="card-title" style="color: white; font-size: 18px; margin: 0; font-weight: 600;">üë§ Personel Bilgileri</h3>
                        </div>
                        <div class="card-body" style="padding: 24px;">
                            <div class="form-group">
                                <label class="form-label">Ad Soyad</label>
                                <input type="text" class="form-control" id="fullName" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Departman</label>
                                <input type="text" class="form-control" id="department" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Unvan</label>
                                <input type="text" class="form-control" id="title" value="Uzman" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Kurum</label>
                                <input type="text" class="form-control" id="company" value="Tez Medikal A.≈û." readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Anla≈üma ≈ûekli</label>
                                <input type="text" class="form-control" id="contractType" value="Belirsiz S√ºreli" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ƒ∞≈ü Yeri</label>
                                <select class="form-control form-select" id="workLocation">
                                    <option value="genel">Genel M√ºd√ºrl√ºk</option>
                                    <option value="saha">Saha</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ƒ∞≈ü Ba≈üƒ± Tarihi</label>
                                <input type="text" class="form-control" id="startWorkDate" value="01.01.2020" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ƒ∞zin Hak Edi≈ü Tarihi</label>
                                <input type="text" class="form-control" id="leaveEarnDate" value="01.01.2025" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Talep Tarihi</label>
                                <input type="text" class="form-control" id="requestDate" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Saƒü: ƒ∞zin Detaylarƒ± -->
                    <div class="card" style="border: none; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); border-radius: 16px; overflow: hidden;">
                    <div class="card-header" style="background: linear-gradient(135deg, #17A2B8 0%, #138496 100%); padding: 20px 24px; border: none;">
                        <h3 class="card-title" style="color: white; font-size: 18px; margin: 0; font-weight: 600;">üìù ƒ∞zin Detaylarƒ±</h3>
                    </div>
                    <div class="card-body" style="padding: 24px;">
                        <div class="form-group">
                            <label class="form-label form-label-required">ƒ∞zin Tipi</label>
                            <select class="form-control form-select" id="leaveType" required>
                                <option value="">Se√ßiniz...</option>
                                <option value="annual">Yƒ±llƒ±k ƒ∞zin</option>
                                <option value="marriage">Evlilik ƒ∞zni</option>
                                <option value="birth">Doƒüum ƒ∞zni</option>
                                <option value="death">√ñl√ºm ƒ∞zni</option>
                                <option value="excuse">Mazeret ƒ∞zni</option>
                                <option value="paternity">Babalƒ±k ƒ∞zni</option>
                                <option value="unpaid">√úcretsiz ƒ∞zin</option>
                                <option value="advance">Avans ƒ∞zin</option>
                                <option value="education">Eƒüitim ƒ∞zni</option>
                                <option value="sickness">Hastalƒ±k ƒ∞zni</option>
                                <option value="adoption">Evlat Edinme ƒ∞zni</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2">
                            <div class="form-group">
                                <label class="form-label form-label-required">Ba≈ülangƒ±√ß Tarihi</label>
                                <input type="date" class="form-control" id="startDate" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label form-label-required">Biti≈ü Tarihi</label>
                                <input type="date" class="form-control" id="endDate" required>
                            </div>
                        </div>

                        <!-- Mazeret ƒ∞zni Saat Alanlarƒ± -->
                        <div id="excuseTimeFields" style="display: none;">
                            <div class="grid grid-cols-2">
                                <div class="form-group">
                                    <label class="form-label">Ba≈ülangƒ±√ß Saati</label>
                                    <input type="time" class="form-control" id="startTime">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Biti≈ü Saati</label>
                                    <input type="time" class="form-control" id="endTime">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Toplam G√ºn</label>
                            <input type="text" class="form-control" id="totalDays" readonly value="0">
                        </div>

                        <div class="form-group">
                            <label class="form-label">A√ßƒ±klama</label>
                            <textarea class="form-control" id="description" rows="4" placeholder="ƒ∞zin sebebinizi belirtiniz..."></textarea>
                        </div>

                        <!-- Dosya Y√ºkleme Alanƒ± (Belirli ƒ∞zin Tipleri ƒ∞√ßin) -->
                        <div class="form-group" id="documentUploadField" style="display: none;">
                            <label class="form-label form-label-required">Belge Y√ºkle</label>
                            <input type="file" class="form-control" id="documentUpload" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" multiple>
                            <small class="form-text text-muted" id="documentHint">Bu izin tipi i√ßin gerekli belgeleri y√ºklemeniz gerekmektedir.</small>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- Saha √áalƒ±≈üanƒ± ƒ∞√ßin Ek Alanlar -->
                <div class="card mb-4" id="sahaFields" style="display: none; border: none; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); border-radius: 16px; overflow: hidden;">
                    <div class="card-header" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px 24px; border: none;">
                        <h3 class="card-title" style="color: white; font-size: 18px; margin: 0; font-weight: 600;">üèóÔ∏è Saha Bilgileri</h3>
                    </div>
                    <div class="card-body" style="padding: 24px;">
                        <div class="form-group">
                            <label class="form-label">Lokasyon</label>
                            <select class="form-control form-select" id="employeeLocation">
                                <option value="">Se√ßiniz...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Lokasyon Sorumlusu / Ekip Lideri</label>
                            <input type="text" class="form-control" id="locationLeader" readonly placeholder="Lokasyon se√ßildikten sonra otomatik gelecek">
                        </div>

                        <div class="form-check mb-3">
                            <input type="checkbox" id="needReplacement" class="form-check-input">
                            <label class="form-check-label" for="needReplacement">
                                Yerine g√∂revlendirme talep ediyorum
                            </label>
                        </div>

                        <div id="replacementLocationField" style="display: none; margin-bottom: 16px;">
                            <div class="form-group">
                                <label class="form-label">Yerine G√∂revlendirme Yapƒ±lacak Lokasyon</label>
                                <select class="form-control form-select" id="replacementLocation">
                                    <option value="">Se√ßiniz...</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-check mb-3">
                            <input type="checkbox" id="notifyMIL" class="form-check-input">
                            <label class="form-check-label" for="notifyMIL">
                                M√º≈üteri ƒ∞li≈ükileri (Mƒ∞L) bilgilendirilsin
                            </label>
                        </div>

                        <div class="form-check">
                            <input type="checkbox" id="noServiceGap" class="form-check-input">
                            <label class="form-check-label" for="noServiceGap">
                                Eksik hizmet olu≈ümayacak
                            </label>
                        </div>

                        <div id="serviceGapFields" style="margin-top: 16px;">
                            <div class="form-group">
                                <label class="form-label">Eksik Hizmet Saƒülayacak Firmalar (√áoklu Se√ßim)</label>
                                <select class="form-control" id="serviceCompanies" multiple style="min-height: 120px;">
                                </select>
                                <small class="form-text text-muted">Ctrl/Cmd tu≈üu ile birden fazla firma se√ßebilirsiniz</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="card" style="border: none; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); border-radius: 16px; overflow: hidden;">
                    <div class="card-body" style="padding: 24px;">
                        <div class="flex gap-md justify-end">
                            <a href="dashboard.html" class="btn btn-secondary">ƒ∞ptal</a>
                            <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 12px 32px; font-weight: 600;">‚úì Talebi G√∂nder</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/tr.js"></script>
    <script src="js/calendar-helper.js"></script>
    <script src="js/app.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
        const userData = JSON.parse(localStorage.getItem(`userData_${user.id}`) || '{}');

        document.getElementById('userName').textContent = user.name || '-';
        document.getElementById('userRole').textContent = user.role === 'employee' ? 'Personel' : 'Y√∂netici';
        document.getElementById('userAvatar').textContent = (user.name || '-').split(' ').map(n => n[0]).join('');
        document.getElementById('fullName').value = user.name || '';
        document.getElementById('department').value = user.department || '';

        // Saha alanlarƒ±nƒ± g√∂ster/gizle fonksiyonu
        function toggleSahaFields() {
            const workLocation = document.getElementById('workLocation').value;
            const sahaFields = document.getElementById('sahaFields');

            if (workLocation === 'saha') {
                sahaFields.style.display = 'block';
                console.log('Saha alanlarƒ± g√∂steriliyor');
            } else {
                sahaFields.style.display = 'none';
                console.log('Saha alanlarƒ± gizleniyor');
            }
        }

        // ƒ∞≈ü yeri varsayƒ±lan deƒüerini ayarla (departmana g√∂re)
        const sahaKeywords = ['√ºretim', 'saha', 'teknik', 'servis', 'montaj', 'bakƒ±m'];
        const userDepartment = (user.department || '').toLowerCase();
        const isSaha = sahaKeywords.some(keyword => userDepartment.includes(keyword));
        document.getElementById('workLocation').value = isSaha ? 'saha' : 'genel';

        // Sayfa y√ºklendiƒüinde saha alanlarƒ±nƒ± kontrol et
        toggleSahaFields();

        // Talep tarihini bug√ºn√ºn tarihi olarak ayarla
        const today = new Date().toLocaleDateString('tr-TR');
        document.getElementById('requestDate').value = today;

        if (userData.leaveBalance) {
            const earned = userData.leaveBalance.earned || 20;
            const used = userData.leaveBalance.used || 5;
            const remaining = userData.leaveBalance.remaining || 15;

            document.getElementById('earnedBalance').textContent = earned;
            document.getElementById('usedBalance').textContent = used;
            document.getElementById('remainingBalance').textContent = remaining;

            // Calculate percentages
            const usedPercentage = Math.round((used / earned) * 100);
            const remainingPercentage = Math.round((remaining / earned) * 100);

            // Update used leave progress ring and bar
            const usedCircumference = 201; // 2 * œÄ * r where r=32
            const usedOffset = usedCircumference - (usedCircumference * usedPercentage / 100);
            const progressCircle = document.getElementById('usedProgressCircle');
            if (progressCircle) {
                progressCircle.style.strokeDashoffset = usedOffset;
            }
            document.getElementById('usedPercentage').querySelector('div').textContent = usedPercentage + '%';
            document.getElementById('usedProgressBar').style.width = usedPercentage + '%';

            // Update remaining leave battery fill
            const batteryMaxWidth = 39; // Max width of battery fill
            const batteryWidth = (batteryMaxWidth * remainingPercentage / 100);
            document.getElementById('batteryFill').setAttribute('width', batteryWidth);
            document.getElementById('remainingPercentage').innerHTML = '<span style="font-size: 16px;">‚úì</span> %' + remainingPercentage + ' kalan';
        }

        // Mock data: Lokasyonlar ve sorumlularƒ±
        const locations = {
            'ankara_proje': { name: 'Ankara Proje Sahasƒ±', leader: 'Mehmet Kaya', companies: ['ABC G√ºvenlik', 'Securitas', 'Koruma Ltd.'] },
            'istanbul_fabrika': { name: 'ƒ∞stanbul Fabrika A', leader: 'Ay≈üe Demir', companies: ['XYZ Temizlik', 'Lojistik A.≈û.', 'Koruma Ltd.'] },
            'izmir_proje': { name: 'ƒ∞zmir Proje Sahasƒ±', leader: 'Ali Yurt', companies: ['DEF G√ºvenlik', 'Koruma Ltd.', 'G√ºven Hizmetleri'] },
            'bursa_proje': { name: 'Bursa Proje Sahasƒ±', leader: 'Kemal Acar', companies: ['Securitas', 'ABC G√ºvenlik', 'Temizlik Hizmetleri'] }
        };

        // Lokasyonlarƒ± doldur
        const locationSelect = document.getElementById('employeeLocation');
        const replacementLocationSelect = document.getElementById('replacementLocation');
        Object.keys(locations).forEach(key => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = locations[key].name;
            locationSelect.appendChild(option.cloneNode(true));
            replacementLocationSelect.appendChild(option);
        });

        // Lokasyon se√ßildiƒüinde lider ve firmalarƒ± doldur
        locationSelect.addEventListener('change', function() {
            const selectedLocation = locations[this.value];
            const leaderInput = document.getElementById('locationLeader');
            const companiesSelect = document.getElementById('serviceCompanies');

            if (selectedLocation) {
                leaderInput.value = selectedLocation.leader;

                // Firmalarƒ± doldur
                companiesSelect.innerHTML = '';
                selectedLocation.companies.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company;
                    option.textContent = company;
                    companiesSelect.appendChild(option);
                });
            } else {
                leaderInput.value = '';
                companiesSelect.innerHTML = '';
            }
        });

        // Yerine g√∂revlendirme checkbox
        document.getElementById('needReplacement').addEventListener('change', function() {
            const replacementField = document.getElementById('replacementLocationField');
            replacementField.style.display = this.checked ? 'block' : 'none';
        });

        // ƒ∞zin tipi deƒüi≈ütiƒüinde
        const documentRequiredTypes = ['death', 'sickness', 'birth', 'marriage'];
        document.getElementById('leaveType').addEventListener('change', function() {
            const excuseFields = document.getElementById('excuseTimeFields');
            const documentField = document.getElementById('documentUploadField');
            const documentHint = document.getElementById('documentHint');

            excuseFields.style.display = this.value === 'excuse' ? 'block' : 'none';

            // Belge gerekli mi kontrol et
            if (documentRequiredTypes.includes(this.value)) {
                documentField.style.display = 'block';
                const hints = {
                    'death': '√ñl√ºm belgesi y√ºklemeniz gerekmektedir.',
                    'sickness': 'Saƒülƒ±k raporu y√ºklemeniz gerekmektedir.',
                    'birth': 'Doƒüum belgesi y√ºklemeniz gerekmektedir.',
                    'marriage': 'Evlilik c√ºzdanƒ± y√ºklemeniz gerekmektedir.'
                };
                documentHint.textContent = hints[this.value] || 'Gerekli belgeleri y√ºklemeniz gerekmektedir.';
            } else {
                documentField.style.display = 'none';
            }
        });

        // √áalƒ±≈üma yeri deƒüi≈ütiƒüinde
        document.getElementById('workLocation').addEventListener('change', toggleSahaFields);

        // Eksik hizmet checkbox
        document.getElementById('noServiceGap').addEventListener('change', function() {
            const fields = document.getElementById('serviceGapFields');
            fields.style.display = this.checked ? 'none' : 'block';
        });

        // Flatpickr ile tarih se√ßicileri ba≈ülat
        let startDatePicker, endDatePicker;

        startDatePicker = flatpickr("#startDate", {
            ...getFlatpickrConfig(),
            onChange: function(selectedDates, dateStr, instance) {
                // Biti≈ü tarihinin minimum deƒüerini g√ºncelle
                if (endDatePicker && selectedDates[0]) {
                    endDatePicker.set('minDate', selectedDates[0]);
                }
                updateLeaveDaysDisplay();
            }
        });

        endDatePicker = flatpickr("#endDate", {
            ...getFlatpickrConfig(),
            onChange: function(selectedDates, dateStr, instance) {
                updateLeaveDaysDisplay();
            }
        });

        // ƒ∞≈ü g√ºn√º sayƒ±sƒ±nƒ± hesapla ve g√∂ster
        function updateLeaveDaysDisplay() {
            const startInput = document.getElementById('startDate');
            const endInput = document.getElementById('endDate');

            if (startInput.value && endInput.value) {
                // Flatpickr'dan tarihleri al
                const startDate = startDatePicker.selectedDates[0];
                const endDate = endDatePicker.selectedDates[0];

                if (startDate && endDate && startDate <= endDate) {
                    const workingDaysCount = calculateWorkingDays(startDate, endDate);
                    document.getElementById('totalDays').value = workingDaysCount + ' i≈ü g√ºn√º';
                } else {
                    document.getElementById('totalDays').value = '0 i≈ü g√ºn√º';
                }
            }
        }

        // Form submit
        document.getElementById('leaveRequestForm').addEventListener('submit', function(e) {
            e.preventDefault();

            // Dosya y√ºkleme kontrol√º
            const documentUpload = document.getElementById('documentUpload');
            const leaveType = document.getElementById('leaveType').value;
            let uploadedDocuments = [];

            if (documentRequiredTypes.includes(leaveType) && documentUpload.files.length > 0) {
                // Dosya bilgilerini kaydet (ger√ßek uygulamada sunucuya y√ºklenecek)
                for (let i = 0; i < documentUpload.files.length; i++) {
                    const file = documentUpload.files[i];
                    uploadedDocuments.push({
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        uploadedAt: new Date().toISOString()
                    });
                }
            }

            // Se√ßili hizmet firmalarƒ±nƒ± al
            const serviceCompaniesSelect = document.getElementById('serviceCompanies');
            const selectedCompanies = Array.from(serviceCompaniesSelect.selectedOptions).map(opt => opt.value);

            const requestData = {
                type: leaveType,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                days: document.getElementById('totalDays').value,
                description: document.getElementById('description').value,
                workLocation: document.getElementById('workLocation').value,
                needReplacement: document.getElementById('needReplacement')?.checked || false,
                // Yeni: Yerine g√∂revlendirme lokasyonu
                replacementLocation: document.getElementById('replacementLocation')?.value || '',
                // Saha workflow additional fields - G√úNCELLENDƒ∞
                employeeLocation: document.getElementById('employeeLocation')?.value || '',
                locationLeader: document.getElementById('locationLeader')?.value || '',
                notifyMIL: document.getElementById('notifyMIL')?.checked || false,
                noServiceGap: document.getElementById('noServiceGap')?.checked || false,
                serviceCompanies: selectedCompanies, // √áoklu se√ßim
                // Yeni: Y√ºklenen dosyalar
                documents: uploadedDocuments,
                hasDocuments: uploadedDocuments.length > 0,
                // Mazeret izni i√ßin saat bilgileri
                startTime: document.getElementById('startTime')?.value || '',
                endTime: document.getElementById('endTime')?.value || ''
            };

            // WorkflowEngine ile talep olu≈ütur
            const request = WorkflowEngine.createRequest(requestData);

            if (request) {
                // Talebi kaydet
                WorkflowEngine.saveRequest(request);

                // Console'a workflow bilgilerini yazdƒ±r
                console.log('üöÄ ƒ∞Zƒ∞N TALEBƒ∞ OLU≈ûTURULDU:');
                console.log('Talep ID:', request.id);
                console.log('Workflow Adƒ±mlarƒ±:', request.workflow.steps);
                console.log('Ge√ßerli Adƒ±m:', request.workflow.currentStep);
                console.log('Y√ºklenen Belgeler:', uploadedDocuments.length);
                console.log('---');

                App.showNotification('ƒ∞zin talebiniz ba≈üarƒ±yla g√∂nderildi! Onay s√ºrecine alƒ±ndƒ±.', 'success');
                setTimeout(() => window.location.href = 'izinlerim.html', 1500);
            } else {
                App.showNotification('Talep olu≈üturulamadƒ±. L√ºtfen tekrar deneyin.', 'error');
            }
        });
    </script>
</body>
</html>