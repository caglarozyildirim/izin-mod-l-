<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bildirimler - Tez Medikal</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .notifications-container {
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-header h1 {
            font-size: 32px;
            color: #1f2937;
            margin: 0 0 10px 0;
        }

        .page-header p {
            color: #6b7280;
            font-size: 16px;
            margin: 0;
        }

        .notifications-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #4b5563;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .notification-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid #e5e7eb;
        }

        .notification-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .notification-card.unread {
            background: #f0f9ff;
            border-left-color: #3b82f6;
        }

        .notification-card.manager_approval {
            border-left-color: #10b981;
        }

        .notification-card.leave_confirmation {
            border-left-color: #f59e0b;
        }

        .notification-card.completion {
            border-left-color: #8b5cf6;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .notification-icon {
            font-size: 24px;
            margin-right: 12px;
        }

        .notification-title {
            flex: 1;
        }

        .notification-title h3 {
            margin: 0 0 4px 0;
            font-size: 18px;
            color: #1f2937;
        }

        .notification-title p {
            margin: 0;
            font-size: 14px;
            color: #6b7280;
        }

        .notification-time {
            font-size: 13px;
            color: #9ca3af;
            white-space: nowrap;
        }

        .notification-body {
            color: #4b5563;
            line-height: 1.6;
            font-size: 15px;
        }

        .notification-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            color: #6b7280;
            font-size: 20px;
            margin: 0 0 10px 0;
        }

        .empty-state p {
            color: #9ca3af;
        }

        .badge-new {
            background: #3b82f6;
            color: white;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="topbar">
        <div class="topbar-container">
            <div class="topbar-left">
                <div class="logo">Tez Medikal</div>
            </div>
            <div class="topbar-right">
                <div class="user-info">
                    <span id="userName"></span>
                    <button onclick="logout()" class="btn btn-sm btn-outline-light">√áƒ±kƒ±≈ü</button>
                </div>
            </div>
        </div>
    </div>

    <div class="notifications-container">
        <div class="page-header">
            <h1>üì¨ Bildirimler</h1>
            <p>E-posta bildirimleri ve sistem mesajlarƒ±</p>
        </div>

        <div class="notifications-tabs">
            <button class="tab active" onclick="filterNotifications('all')">
                T√ºm√º <span id="allCount" class="badge-new">0</span>
            </button>
            <button class="tab" onclick="filterNotifications('unread')">
                Okunmamƒ±≈ü <span id="unreadCount" class="badge-new">0</span>
            </button>
            <button class="tab" onclick="filterNotifications('manager_approval')">
                Onay Bildirimleri
            </button>
            <button class="tab" onclick="filterNotifications('leave_confirmation')">
                ƒ∞zin Onaylarƒ±
            </button>
        </div>

        <div id="notificationsContainer">
            <!-- Notifications will be loaded here -->
        </div>
    </div>

    <script src="js/app.js"></script>
    <script src="js/workflow-engine.js"></script>
    <script>
        // Auth check
        checkAuth();
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        document.getElementById('userName').textContent = currentUser.name;

        let currentFilter = 'all';
        let notifications = [];

        // Icon mapping
        const iconMap = {
            'manager_approval': '‚úÖ',
            'leave_confirmation': '‚è±Ô∏è',
            'completion': 'üéâ',
            'reminder': '‚ö†Ô∏è'
        };

        // Title mapping
        const titleMap = {
            'manager_approval': 'ƒ∞zin Onaylandƒ±',
            'leave_confirmation': 'ƒ∞zin Kullanƒ±m Onayƒ±',
            'completion': 'ƒ∞zin Tamamlandƒ±',
            'reminder': 'Hatƒ±rlatma'
        };

        // Load notifications
        function loadNotifications() {
            const allNotifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            notifications = allNotifications.filter(n => n.userId === currentUser.id);

            // Sort by timestamp (newest first)
            notifications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Update counts
            document.getElementById('allCount').textContent = notifications.length;
            document.getElementById('unreadCount').textContent = notifications.filter(n => !n.read).length;

            // Display notifications
            displayNotifications();
        }

        // Filter notifications
        function filterNotifications(filter) {
            currentFilter = filter;

            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.closest('.tab').classList.add('active');

            displayNotifications();
        }

        // Display notifications
        function displayNotifications() {
            const container = document.getElementById('notificationsContainer');

            let filteredNotifications = notifications;

            if (currentFilter !== 'all') {
                if (currentFilter === 'unread') {
                    filteredNotifications = notifications.filter(n => !n.read);
                } else {
                    filteredNotifications = notifications.filter(n => n.type === currentFilter);
                }
            }

            if (filteredNotifications.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <h3>Bildirim Yok</h3>
                        <p>${currentFilter === 'unread' ? 'T√ºm bildirimler okundu' : 'Hen√ºz bildirim bulunmuyor'}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredNotifications.map(notification => {
                const icon = iconMap[notification.type] || 'üìß';
                const title = notification.subject || titleMap[notification.type] || 'Bildirim';

                return `
                    <div class="notification-card ${notification.read ? '' : 'unread'} ${notification.type}" onclick="openNotification('${notification.id}')">
                        <div class="notification-header">
                            <div style="display: flex; align-items: start; flex: 1;">
                                <span class="notification-icon">${icon}</span>
                                <div class="notification-title">
                                    <h3>${title} ${!notification.read ? '<span class="badge-new">YENƒ∞</span>' : ''}</h3>
                                    <p>Talep No: ${notification.requestId}</p>
                                </div>
                            </div>
                            <span class="notification-time">${formatTime(notification.timestamp)}</span>
                        </div>
                        <div class="notification-body">
                            ${generateNotificationBody(notification)}
                        </div>
                        ${generateNotificationActions(notification)}
                    </div>
                `;
            }).join('');
        }

        // Generate notification body based on type
        function generateNotificationBody(notification) {
            const data = notification.data || {};

            switch (notification.type) {
                case 'manager_approval':
                    return `
                        <p><strong>${data.employeeName}</strong>, izin talebiniz y√∂neticiniz tarafƒ±ndan onaylanmƒ±≈ütƒ±r.</p>
                        <p>ƒ∞zin T√ºr√º: <strong>${getLeaveTypeName(data.leaveType)}</strong></p>
                        <p>Tarih: ${formatDate(data.startDate)} - ${formatDate(data.endDate)} (${data.totalDays})</p>
                        <p style="margin-top: 12px; color: #f59e0b;"><strong>‚ö†Ô∏è Dikkat:</strong> ƒ∞zin formunu olu≈üturup imzalƒ± halini y√ºklemeniz gerekmektedir.</p>
                    `;

                case 'leave_confirmation':
                    return `
                        <p>ƒ∞zin d√∂neminiz sona ermi≈ütir. L√ºtfen izninizi fiilen kullandƒ±ƒüƒ±nƒ±zƒ± onaylayƒ±n.</p>
                        <p>ƒ∞zin T√ºr√º: <strong>${getLeaveTypeName(data.leaveType)}</strong></p>
                        <p>Tarih: ${formatDate(data.startDate)} - ${formatDate(data.endDate)}</p>
                        <p style="margin-top: 12px; color: #f59e0b;"><strong>‚è±Ô∏è √ñnemli:</strong> Bu onayƒ± 24 saat i√ßinde yapmazsanƒ±z otomatik olarak onaylanacaktƒ±r.</p>
                    `;

                case 'completion':
                    return `
                        <p>ƒ∞zin kaydƒ±nƒ±z ba≈üarƒ±yla tamamlanmƒ±≈ütƒ±r.</p>
                        <p>ƒ∞zin T√ºr√º: <strong>${getLeaveTypeName(data.leaveType)}</strong></p>
                        <p>Tarih: ${formatDate(data.startDate)} - ${formatDate(data.endDate)}</p>
                        <p style="margin-top: 12px; color: #10b981;">‚úì ƒ∞zininiz ƒ∞K kayƒ±tlarƒ±na i≈ülenmi≈ütir.</p>
                    `;

                default:
                    return '<p>Yeni bir bildiriminiz var.</p>';
            }
        }

        // Generate notification actions
        function generateNotificationActions(notification) {
            const data = notification.data || {};
            let actions = '';

            switch (notification.type) {
                case 'manager_approval':
                    actions = `
                        <div class="notification-actions">
                            <a href="${data.formCreateLink}" class="btn btn-primary btn-sm">üìÑ Form Olu≈ütur</a>
                            <button class="btn btn-secondary btn-sm" onclick="markAsRead('${notification.id}'); event.stopPropagation();">‚úì Okundu</button>
                        </div>
                    `;
                    break;

                case 'leave_confirmation':
                    actions = `
                        <div class="notification-actions">
                            <a href="${data.confirmationLink}" class="btn btn-primary btn-sm">‚úì ƒ∞zin Kullanƒ±mƒ±nƒ± Onayla</a>
                            <button class="btn btn-secondary btn-sm" onclick="markAsRead('${notification.id}'); event.stopPropagation();">‚úì Okundu</button>
                        </div>
                    `;
                    break;

                default:
                    if (!notification.read) {
                        actions = `
                            <div class="notification-actions">
                                <button class="btn btn-secondary btn-sm" onclick="markAsRead('${notification.id}'); event.stopPropagation();">‚úì Okundu ƒ∞≈üaretle</button>
                            </div>
                        `;
                    }
            }

            return actions;
        }

        // Open notification
        function openNotification(notificationId) {
            markAsRead(notificationId);
        }

        // Mark notification as read
        function markAsRead(notificationId) {
            const allNotifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            const index = allNotifications.findIndex(n => n.id === notificationId);

            if (index !== -1) {
                allNotifications[index].read = true;
                localStorage.setItem('notifications', JSON.stringify(allNotifications));
                loadNotifications();
            }
        }

        // Format time
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return '≈ûimdi';
            if (diffMins < 60) return `${diffMins} dakika √∂nce`;
            if (diffHours < 24) return `${diffHours} saat √∂nce`;
            if (diffDays < 7) return `${diffDays} g√ºn √∂nce`;

            return date.toLocaleDateString('tr-TR', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('tr-TR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Get leave type name
        function getLeaveTypeName(type) {
            const types = {
                'annual': 'Yƒ±llƒ±k ƒ∞zin',
                'sick': 'Hastalƒ±k ƒ∞zni',
                'excused': 'Mazeret ƒ∞zni',
                'maternity': 'Doƒüum ƒ∞zni',
                'paternity': 'Babalƒ±k ƒ∞zni',
                'unpaid': '√úcretsiz ƒ∞zin',
                'marriage': 'Evlilik ƒ∞zni',
                'death': '√ñl√ºm ƒ∞zni'
            };
            return types[type] || type;
        }

        // Load notifications on page load
        loadNotifications();
    </script>
</body>
</html>
