<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raporlar - Tez Medikal</title>
    <link rel="stylesheet" href="css/design-system.css">
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        /* Flatpickr √∂zel stiller */
        .flatpickr-calendar {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .flatpickr-day.holiday {
            color: #dc2626 !important;
            font-weight: bold;
            background: #fee2e2 !important;
        }
        .flatpickr-day.weekend {
            color: #9ca3af !important;
            background: #f3f4f6 !important;
        }
        .flatpickr-day.selected {
            background: #3b82f6 !important;
            border-color: #3b82f6 !important;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <div style="width: 40px; height: 40px; background: var(--primary); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">TM</div>
            <span>Tez Medikal</span>
        </div>
        <div class="navbar-menu">
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="onay-yonetimi.html" class="nav-link">Onay Bekleyenler</a>
            <a href="tum-izinler.html" class="nav-link">T√ºm ƒ∞zinler</a>
            <a href="raporlar.html" class="nav-link active">Raporlar</a>
        </div>
        <div class="navbar-user">
            <div class="user-info">
                <div class="user-name" id="userName">-</div>
                <div class="user-role" id="userRole">-</div>
            </div>
            <div class="user-avatar" id="userAvatar">-</div>
            <button class="btn btn-ghost btn-sm" data-action="logout">√áƒ±kƒ±≈ü</button>
        </div>
    </nav>

    <main class="main-content">
        <div class="container-fluid">
            <div class="page-header">
                <h1 class="page-title">ƒ∞zin Raporlarƒ±</h1>
                <p class="page-subtitle">Detaylƒ± izin kullanƒ±m analizi ve raporlar</p>
            </div>

            <!-- Report Filters -->
            <div class="card mb-5">
                <div class="card-header">
                    <h3 class="card-title">Rapor Filtreleri</h3>
                </div>
                <div class="card-body">
                    <div class="grid grid-cols-4 mb-3">
                        <div class="form-group">
                            <label class="form-label">Ba≈ülangƒ±√ß Tarihi</label>
                            <input type="date" class="form-control" id="startDate" value="2025-01-01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Biti≈ü Tarihi</label>
                            <input type="date" class="form-control" id="endDate" value="2025-12-31">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Departman</label>
                            <select class="form-control form-select" id="departmentSelect">
                                <option value="">T√ºm Departmanlar</option>
                                <option value="uretim">√úretim</option>
                                <option value="muhasebe">Muhasebe</option>
                                <option value="it">IT</option>
                                <option value="satis">Satƒ±≈ü</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Rapor Tipi</label>
                            <select class="form-control form-select" id="reportType">
                                <option value="summary">√ñzet Rapor</option>
                                <option value="detailed">Detaylƒ± Rapor</option>
                                <option value="department">Departman Bazlƒ±</option>
                                <option value="employee">Personel Bazlƒ±</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-md">
                        <button class="btn btn-primary" onclick="generateReport()">üìä Rapor Olu≈ütur</button>
                        <button class="btn btn-success" onclick="exportExcel()">üì• Excel ƒ∞ndir</button>
                        <button class="btn btn-secondary" onclick="exportPDF()">üìÑ PDF ƒ∞ndir</button>
                    </div>
                </div>
            </div>

            <!-- Summary Stats -->
            <div class="grid grid-cols-4 mb-5">
                <div class="stat-card">
                    <div class="stat-label">Toplam ƒ∞zin Talebi</div>
                    <div class="stat-value">156</div>
                    <div class="stat-subtitle">2025 Yƒ±lƒ±</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-label">Onaylanan Talepler</div>
                    <div class="stat-value">132</div>
                    <div class="stat-subtitle">%84.6 Onay Oranƒ±</div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-label">Reddedilen Talepler</div>
                    <div class="stat-value">16</div>
                    <div class="stat-subtitle">%10.3 Red Oranƒ±</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-label">Bekleyen Talepler</div>
                    <div class="stat-value">8</div>
                    <div class="stat-subtitle">%5.1 Beklemede</div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-2 mb-5" style="gap: 20px;">
                <!-- Leave Type Distribution -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ƒ∞zin Tipi Daƒüƒ±lƒ±mƒ±</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 14px; font-weight: 500;">Yƒ±llƒ±k ƒ∞zin</span>
                                    <span style="font-size: 14px; color: var(--text-tertiary);">85 talep (54%)</span>
                                </div>
                                <div style="height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: 54%; background: var(--primary);"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 14px; font-weight: 500;">Hastalƒ±k ƒ∞zni</span>
                                    <span style="font-size: 14px; color: var(--text-tertiary);">32 talep (20%)</span>
                                </div>
                                <div style="height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: 20%; background: var(--danger);"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 14px; font-weight: 500;">Mazeret ƒ∞zni</span>
                                    <span style="font-size: 14px; color: var(--text-tertiary);">24 talep (15%)</span>
                                </div>
                                <div style="height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: 15%; background: var(--warning);"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 14px; font-weight: 500;">Diƒüer ƒ∞zinler</span>
                                    <span style="font-size: 14px; color: var(--text-tertiary);">15 talep (11%)</span>
                                </div>
                                <div style="height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: 11%; background: var(--info);"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Department Usage -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Departman ƒ∞zin Kullanƒ±mƒ±</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 14px; font-weight: 500;">√úretim</span>
                                    <span style="font-size: 14px; color: var(--text-tertiary);">240/400 g√ºn (%60)</span>
                                </div>
                                <div style="height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: 60%; background: var(--primary);"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 14px; font-weight: 500;">Muhasebe</span>
                                    <span style="font-size: 14px; color: var(--text-tertiary);">135/300 g√ºn (%45)</span>
                                </div>
                                <div style="height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: 45%; background: var(--success);"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 14px; font-weight: 500;">IT</span>
                                    <span style="font-size: 14px; color: var(--text-tertiary);">90/300 g√ºn (%30)</span>
                                </div>
                                <div style="height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: 30%; background: var(--info);"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 14px; font-weight: 500;">Satƒ±≈ü</span>
                                    <span style="font-size: 14px; color: var(--text-tertiary);">175/250 g√ºn (%70)</span>
                                </div>
                                <div style="height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: 70%; background: var(--warning);"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monthly Trend -->
            <div class="card mb-5">
                <div class="card-header">
                    <h3 class="card-title">Aylƒ±k ƒ∞zin Talebi Trendi</h3>
                </div>
                <div class="card-body">
                    <div id="monthlyTrendChart" style="display: flex; align-items: flex-end; justify-content: space-between; height: 200px; gap: 8px;">
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                            <div style="width: 100%; background: var(--primary); border-radius: 4px 4px 0 0; height: 45%; position: relative;">
                                <span style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: 600;">12</span>
                            </div>
                            <span style="font-size: 11px; margin-top: 8px; color: var(--text-tertiary);">Oca</span>
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                            <div style="width: 100%; background: var(--primary); border-radius: 4px 4px 0 0; height: 38%; position: relative;">
                                <span style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: 600;">10</span>
                            </div>
                            <span style="font-size: 11px; margin-top: 8px; color: var(--text-tertiary);">≈ûub</span>
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                            <div style="width: 100%; background: var(--primary); border-radius: 4px 4px 0 0; height: 60%; position: relative;">
                                <span style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: 600;">16</span>
                            </div>
                            <span style="font-size: 11px; margin-top: 8px; color: var(--text-tertiary);">Mar</span>
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                            <div style="width: 100%; background: var(--primary); border-radius: 4px 4px 0 0; height: 52%; position: relative;">
                                <span style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: 600;">14</span>
                            </div>
                            <span style="font-size: 11px; margin-top: 8px; color: var(--text-tertiary);">Nis</span>
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                            <div style="width: 100%; background: var(--primary); border-radius: 4px 4px 0 0; height: 75%; position: relative;">
                                <span style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: 600;">20</span>
                            </div>
                            <span style="font-size: 11px; margin-top: 8px; color: var(--text-tertiary);">May</span>
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                            <div style="width: 100%; background: var(--primary); border-radius: 4px 4px 0 0; height: 85%; position: relative;">
                                <span style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: 600;">23</span>
                            </div>
                            <span style="font-size: 11px; margin-top: 8px; color: var(--text-tertiary);">Haz</span>
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                            <div style="width: 100%; background: var(--primary); border-radius: 4px 4px 0 0; height: 90%; position: relative;">
                                <span style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: 600;">24</span>
                            </div>
                            <span style="font-size: 11px; margin-top: 8px; color: var(--text-tertiary);">Tem</span>
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                            <div style="width: 100%; background: var(--primary); border-radius: 4px 4px 0 0; height: 100%; position: relative;">
                                <span style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: 600;">27</span>
                            </div>
                            <span style="font-size: 11px; margin-top: 8px; color: var(--text-tertiary);">Aƒüu</span>
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                            <div style="width: 100%; background: var(--primary); border-radius: 4px 4px 0 0; height: 30%; position: relative;">
                                <span style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: 600;">8</span>
                            </div>
                            <span style="font-size: 11px; margin-top: 8px; color: var(--text-tertiary);">Eyl</span>
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                            <div style="width: 100%; background: var(--info); border-radius: 4px 4px 0 0; height: 22%; position: relative;">
                                <span style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: 600;">6</span>
                            </div>
                            <span style="font-size: 11px; margin-top: 8px; color: var(--text-tertiary);">Eki</span>
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                            <div style="width: 100%; background: var(--info); border-radius: 4px 4px 0 0; height: 30%; position: relative;">
                                <span style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: 600;">8</span>
                            </div>
                            <span style="font-size: 11px; margin-top: 8px; color: var(--primary); font-weight: 600;">Kas</span>
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                            <div style="width: 100%; background: var(--gray-300); border-radius: 4px 4px 0 0; height: 18%; position: relative;">
                                <span style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: 600; color: var(--text-tertiary);">?</span>
                            </div>
                            <span style="font-size: 11px; margin-top: 8px; color: var(--text-tertiary);">Ara</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Unused Leave (HR Only) -->
            <div class="card mb-5" id="topUnusedLeaveCard" style="display: none;">
                <div class="card-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                    <h3 class="card-title" style="color: white; margin: 0;">‚ö†Ô∏è En Fazla Kullanƒ±lmamƒ±≈ü ƒ∞zni Olan 10 √áalƒ±≈üan</h3>
                    <p style="margin: 8px 0 0 0; font-size: 13px; opacity: 0.9;">ƒ∞K raporlamasƒ± - izin kullanƒ±mƒ± d√º≈ü√ºk √ßalƒ±≈üanlar</p>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Sƒ±ra</th>
                                <th>Personel</th>
                                <th>Departman</th>
                                <th>Hak Edilen</th>
                                <th>Kullanƒ±lan</th>
                                <th>Kalan ƒ∞zin</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody id="topUnusedLeaveTableBody">
                            <!-- JavaScript ile doldurulacak -->
                        </tbody>
                    </table>
                </div>
                <div class="card-footer">
                    <small class="text-muted">Bu rapor sadece ƒ∞K yetkilileri tarafƒ±ndan g√∂r√ºnt√ºlenebilir</small>
                </div>
            </div>

            <!-- Top Users -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">En √áok ƒ∞zin Kullanan Personel</h3>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Sƒ±ra</th>
                                <th>Personel</th>
                                <th>Departman</th>
                                <th>Hak Edilen</th>
                                <th>Kullanƒ±lan</th>
                                <th>Kalan</th>
                                <th>Kullanƒ±m Oranƒ±</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>#1</strong></td>
                                <td>Mehmet Demir</td>
                                <td>Satƒ±≈ü</td>
                                <td>20 g√ºn</td>
                                <td>18 g√ºn</td>
                                <td>2 g√ºn</td>
                                <td><span class="badge badge-danger">%90</span></td>
                            </tr>
                            <tr>
                                <td><strong>#2</strong></td>
                                <td>Ay≈üe Kaya</td>
                                <td>√úretim</td>
                                <td>20 g√ºn</td>
                                <td>16 g√ºn</td>
                                <td>4 g√ºn</td>
                                <td><span class="badge badge-warning">%80</span></td>
                            </tr>
                            <tr>
                                <td><strong>#3</strong></td>
                                <td>Ali Yƒ±lmaz</td>
                                <td>Muhasebe</td>
                                <td>20 g√ºn</td>
                                <td>15 g√ºn</td>
                                <td>5 g√ºn</td>
                                <td><span class="badge badge-warning">%75</span></td>
                            </tr>
                            <tr>
                                <td><strong>#4</strong></td>
                                <td>Fatma √ñz</td>
                                <td>IT</td>
                                <td>20 g√ºn</td>
                                <td>12 g√ºn</td>
                                <td>8 g√ºn</td>
                                <td><span class="badge badge-info">%60</span></td>
                            </tr>
                            <tr>
                                <td><strong>#5</strong></td>
                                <td>Can ≈ûahin</td>
                                <td>Satƒ±≈ü</td>
                                <td>20 g√ºn</td>
                                <td>10 g√ºn</td>
                                <td>10 g√ºn</td>
                                <td><span class="badge badge-success">%50</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/tr.js"></script>
    <script src="js/calendar-helper.js"></script>
    <script src="js/app.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('currentUser') || '{}');

        document.getElementById('userName').textContent = user.name || '-';
        document.getElementById('userRole').textContent = user.role === 'manager' ? 'Y√∂netici' : user.role === 'hr' ? 'ƒ∞nsan Kaynaklarƒ±' : user.role === 'customerRelations' ? 'M√º≈üteri ƒ∞li≈ükileri' : '√áalƒ±≈üan';
        document.getElementById('userAvatar').textContent = (user.name || '-').split(' ').map(n => n[0]).join('');

        // ƒ∞K kullanƒ±cƒ±sƒ± ise "Kullanƒ±lmamƒ±≈ü ƒ∞zin" raporunu g√∂ster
        if (user.role === 'hr') {
            document.getElementById('topUnusedLeaveCard').style.display = 'block';
            loadTopUnusedLeaveReport();
        }

        // √ñrnek veri olu≈ütur (eƒüer yoksa)
        function ensureSampleData() {
            if (!user.id) return;

            const userData = localStorage.getItem(`userData_${user.id}`);
            if (!userData || JSON.parse(userData).leaveRequests?.length === 0) {
                console.log('√ñrnek veriler olu≈üturuluyor...');

                const sampleData = {
                    leaveBalance: {
                        earned: 20,
                        used: 5,
                        remaining: 15
                    },
                    leaveRequests: [
                        {
                            id: 'req_sample_1',
                            userId: user.id,
                            type: 'annual',
                            startDate: '2025-01-15',
                            endDate: '2025-01-19',
                            days: '5 g√ºn',
                            description: 'Yƒ±llƒ±k izin',
                            status: 'approved',
                            createdAt: '2025-01-10T10:00:00.000Z'
                        },
                        {
                            id: 'req_sample_2',
                            userId: user.id,
                            type: 'annual',
                            startDate: '2025-03-10',
                            endDate: '2025-03-14',
                            days: '5 g√ºn',
                            description: 'Yƒ±llƒ±k izin',
                            status: 'approved',
                            createdAt: '2025-03-05T10:00:00.000Z'
                        },
                        {
                            id: 'req_sample_3',
                            userId: user.id,
                            type: 'sickness',
                            startDate: '2025-05-20',
                            endDate: '2025-05-22',
                            days: '3 g√ºn',
                            description: 'Hastalƒ±k izni',
                            status: 'approved',
                            createdAt: '2025-05-19T10:00:00.000Z'
                        },
                        {
                            id: 'req_sample_4',
                            userId: user.id,
                            type: 'annual',
                            startDate: '2025-07-01',
                            endDate: '2025-07-10',
                            days: '10 g√ºn',
                            description: 'Yaz tatili',
                            status: 'approved',
                            createdAt: '2025-06-25T10:00:00.000Z'
                        },
                        {
                            id: 'req_sample_5',
                            userId: user.id,
                            type: 'excuse',
                            startDate: '2025-09-05',
                            endDate: '2025-09-05',
                            days: '1 g√ºn',
                            description: 'Ki≈üisel i≈üler',
                            status: 'approved',
                            createdAt: '2025-09-01T10:00:00.000Z'
                        },
                        {
                            id: 'req_sample_6',
                            userId: user.id,
                            type: 'annual',
                            startDate: '2025-10-15',
                            endDate: '2025-10-18',
                            days: '4 g√ºn',
                            description: 'Yƒ±llƒ±k izin',
                            status: 'pending',
                            createdAt: '2025-10-10T10:00:00.000Z'
                        },
                        {
                            id: 'req_sample_7',
                            userId: user.id,
                            type: 'annual',
                            startDate: '2025-11-20',
                            endDate: '2025-11-22',
                            days: '3 g√ºn',
                            description: 'Kƒ±sa izin',
                            status: 'pending',
                            createdAt: new Date().toISOString()
                        }
                    ]
                };

                localStorage.setItem(`userData_${user.id}`, JSON.stringify(sampleData));
                console.log('√ñrnek veriler olu≈üturuldu ve kaydedildi!');
            }
        }

        // Sayfa y√ºklendiƒüinde √∂rnek verileri kontrol et
        ensureSampleData();

        // ƒ∞K i√ßin: En fazla kullanƒ±lmamƒ±≈ü izni olan 10 √ßalƒ±≈üan
        function loadTopUnusedLeaveReport() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const employeeLeaveData = [];

            // T√ºm kullanƒ±cƒ±larƒ±n izin bilgilerini topla
            users.forEach(u => {
                if (u.role === 'employee') { // Sadece √ßalƒ±≈üanlarƒ± g√∂ster
                    const userData = JSON.parse(localStorage.getItem(`userData_${u.id}`) || '{}');
                    const leaveBalance = userData.leaveBalance || { earned: 20, used: 0, remaining: 20 };

                    employeeLeaveData.push({
                        name: u.name,
                        department: u.department,
                        earned: leaveBalance.earned || 20,
                        used: leaveBalance.used || 0,
                        remaining: leaveBalance.remaining || 20
                    });
                }
            });

            // Kalan izne g√∂re azalan sƒ±rada sƒ±rala (en fazla kalan en √ºstte)
            employeeLeaveData.sort((a, b) => b.remaining - a.remaining);

            // ƒ∞lk 10'u al
            const top10 = employeeLeaveData.slice(0, 10);

            // Tabloyu doldur
            const tableBody = document.getElementById('topUnusedLeaveTableBody');
            if (!tableBody) return;

            if (top10.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                            <div style="font-size: 32px; margin-bottom: 8px;">üìä</div>
                            <div>Hen√ºz √ßalƒ±≈üan verisi bulunmuyor</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = top10.map((emp, index) => {
                const usageRate = emp.earned > 0 ? Math.round((emp.used / emp.earned) * 100) : 0;
                let badgeClass = 'success';
                let statusText = 'Normal';

                if (usageRate < 25) {
                    badgeClass = 'danger';
                    statusText = '√áok D√º≈ü√ºk';
                } else if (usageRate < 50) {
                    badgeClass = 'warning';
                    statusText = 'D√º≈ü√ºk';
                }

                return `
                    <tr>
                        <td><strong>#${index + 1}</strong></td>
                        <td>${emp.name}</td>
                        <td>${emp.department || 'Bilinmiyor'}</td>
                        <td><span class="badge badge-info">${emp.earned} g√ºn</span></td>
                        <td><span class="badge badge-secondary">${emp.used} g√ºn</span></td>
                        <td><strong style="color: #f59e0b; font-size: 16px;">${emp.remaining} g√ºn</strong></td>
                        <td><span class="badge badge-${badgeClass}">${statusText} (%${usageRate})</span></td>
                    </tr>
                `;
            }).join('');
        }

        // Ger√ßek verileri y√ºkle
        function loadReportData() {
            try {
                // T√ºm kullanƒ±cƒ±larƒ±n verilerini topla
                const allRequests = [];
                const users = JSON.parse(localStorage.getItem('users') || '[]');

                users.forEach(u => {
                    const userData = JSON.parse(localStorage.getItem(`userData_${u.id}`) || '{}');
                    if (userData.leaveRequests && Array.isArray(userData.leaveRequests)) {
                        userData.leaveRequests.forEach(req => {
                            allRequests.push({
                                ...req,
                                userName: u.name,
                                userDepartment: u.department
                            });
                        });
                    }
                });

                if (allRequests.length === 0) {
                    console.log('Hen√ºz izin talebi bulunmuyor - demo veriler g√∂steriliyor');
                    // Demo verilerle g√∂ster
                    updateMonthlyTrendChart([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]);
                    return;
                }

                // ƒ∞statistikleri hesapla
                const totalRequests = allRequests.length;
                const approvedRequests = allRequests.filter(r => r && r.status === 'approved').length;
                const rejectedRequests = allRequests.filter(r => r && r.status === 'rejected').length;
                const pendingRequests = allRequests.filter(r => r && r.status === 'pending').length;

                // Statlarƒ± g√ºncelle
                const statCards = document.querySelectorAll('.stat-card');
                if (statCards[0]) {
                    const valueElem = statCards[0].querySelector('.stat-value');
                    if (valueElem) valueElem.textContent = totalRequests;
                }
                if (statCards[1]) {
                    const valueElem = statCards[1].querySelector('.stat-value');
                    const subtitleElem = statCards[1].querySelector('.stat-subtitle');
                    if (valueElem) valueElem.textContent = approvedRequests;
                    if (subtitleElem) subtitleElem.textContent = `%${totalRequests > 0 ? Math.round((approvedRequests / totalRequests) * 100) : 0} Onay Oranƒ±`;
                }
                if (statCards[2]) {
                    const valueElem = statCards[2].querySelector('.stat-value');
                    const subtitleElem = statCards[2].querySelector('.stat-subtitle');
                    if (valueElem) valueElem.textContent = rejectedRequests;
                    if (subtitleElem) subtitleElem.textContent = `%${totalRequests > 0 ? Math.round((rejectedRequests / totalRequests) * 100) : 0} Red Oranƒ±`;
                }
                if (statCards[3]) {
                    const valueElem = statCards[3].querySelector('.stat-value');
                    const subtitleElem = statCards[3].querySelector('.stat-subtitle');
                    if (valueElem) valueElem.textContent = pendingRequests;
                    if (subtitleElem) subtitleElem.textContent = `%${totalRequests > 0 ? Math.round((pendingRequests / totalRequests) * 100) : 0} Beklemede`;
                }

                // ƒ∞zin tipi daƒüƒ±lƒ±mƒ±nƒ± hesapla
                const leaveTypes = {};
                const leaveTypeNames = {
                    'annual': 'Yƒ±llƒ±k ƒ∞zin',
                    'sickness': 'Hastalƒ±k ƒ∞zni',
                    'excuse': 'Mazeret ƒ∞zni',
                    'marriage': 'Evlilik ƒ∞zni',
                    'birth': 'Doƒüum ƒ∞zni',
                    'death': '√ñl√ºm ƒ∞zni',
                    'paternity': 'Babalƒ±k ƒ∞zni',
                    'unpaid': '√úcretsiz ƒ∞zin',
                    'advance': 'Avans ƒ∞zin',
                    'education': 'Eƒüitim ƒ∞zni',
                    'adoption': 'Evlat Edinme ƒ∞zni'
                };

                allRequests.forEach(req => {
                    if (req && req.type) {
                        const type = req.type;
                        leaveTypes[type] = (leaveTypes[type] || 0) + 1;
                    }
                });

                // Aylƒ±k trend hesapla
                const monthlyData = Array(12).fill(0);
                allRequests.forEach(req => {
                    if (req && req.createdAt) {
                        try {
                            const date = new Date(req.createdAt);
                            const month = date.getMonth();
                            if (month >= 0 && month < 12) {
                                monthlyData[month]++;
                            }
                        } catch (e) {
                            console.warn('Tarih parse hatasƒ±:', req.createdAt);
                        }
                    }
                });

                console.log('Y√ºklenen rapor verileri:', {
                    totalRequests,
                    approvedRequests,
                    rejectedRequests,
                    pendingRequests,
                    leaveTypes,
                    monthlyData
                });

                // Aylƒ±k trend grafiƒüini g√ºncelle
                updateMonthlyTrendChart(monthlyData);

            } catch (error) {
                console.error('Rapor verileri y√ºklenirken hata:', error);
            }
        }

        // Aylƒ±k trend grafiƒüini g√ºncelle - Pƒ∞XEL BAZLI
        function updateMonthlyTrendChart(monthlyData) {
            const chartContainer = document.getElementById('monthlyTrendChart');
            if (!chartContainer) {
                console.error('Chart container bulunamadƒ±!');
                return;
            }

            console.log('Grafik g√ºncelleniyor...', monthlyData);

            const monthNames = ['Oca', '≈ûub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'Aƒüu', 'Eyl', 'Eki', 'Kas', 'Ara'];
            const maxValue = Math.max(...monthlyData, 1);
            const currentMonth = new Date().getMonth();
            const maxHeight = 180; // Maksimum bar y√ºksekliƒüi (px)

            // Mevcut HTML'i TAMAMEN temizle
            chartContainer.innerHTML = '';

            // Her ayƒ± DOM'a ekle
            monthlyData.forEach((count, index) => {
                // Pixel bazlƒ± y√ºkseklik hesapla
                const barHeight = count > 0 ? Math.round((count / maxValue) * maxHeight) : 10;

                let barColor = '#3b82f6'; // primary
                let textColor = '#6b7280';
                let fontWeight = 'normal';

                if (index > currentMonth) {
                    barColor = '#d1d5db'; // gray
                    textColor = '#9ca3af';
                } else if (index === currentMonth) {
                    barColor = '#06b6d4'; // info
                    textColor = '#3b82f6';
                    fontWeight = '600';
                }

                // Container div
                const barContainer = document.createElement('div');
                barContainer.style.cssText = 'flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;';

                // Bar div - Pƒ∞XEL Y√úKSEKLIK
                const bar = document.createElement('div');
                bar.style.cssText = `width: 100%; background: ${barColor}; border-radius: 4px 4px 0 0; height: ${barHeight}px; position: relative;`;

                // Sayƒ± label
                const label = document.createElement('span');
                label.style.cssText = `position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: 600; color: ${index > currentMonth ? '#9ca3af' : '#1f2937'}; white-space: nowrap;`;
                label.textContent = count || (index > currentMonth ? '?' : '0');

                bar.appendChild(label);

                // Ay ismi
                const monthLabel = document.createElement('span');
                monthLabel.style.cssText = `font-size: 11px; margin-top: 8px; color: ${textColor}; font-weight: ${fontWeight};`;
                monthLabel.textContent = monthNames[index];

                barContainer.appendChild(bar);
                barContainer.appendChild(monthLabel);
                chartContainer.appendChild(barContainer);
            });

            console.log('Grafik √ßizildi! Toplam bar sayƒ±sƒ±:', chartContainer.children.length);
            console.log('Maksimum deƒüer:', maxValue, 'Max y√ºkseklik:', maxHeight + 'px');
        }

        // BASIT Y√ñNTEM: Direkt dummy data ile √ßiz
        setTimeout(() => {
            console.log('Dummy data ile grafik √ßiziliyor...');
            const dummyData = [12, 10, 16, 14, 20, 23, 24, 27, 8, 6, 8, 0];
            updateMonthlyTrendChart(dummyData);
        }, 100);

        function generateReport() {
            App.showNotification('Rapor olu≈üturuluyor...', 'info');
            setTimeout(() => {
                loadReportData();
                App.showNotification('Rapor ba≈üarƒ±yla olu≈üturuldu!', 'success');
            }, 1000);
        }

        function exportExcel() {
            App.showNotification('Excel dosyasƒ± indiriliyor...', 'info');
            // Simulate export
            setTimeout(() => {
                App.showNotification('Excel raporu ba≈üarƒ±yla indirildi!', 'success');
            }, 1000);
        }

        function exportPDF() {
            App.showNotification('PDF dosyasƒ± olu≈üturuluyor...', 'info');
            // Simulate export
            setTimeout(() => {
                App.showNotification('PDF raporu ba≈üarƒ±yla indirildi!', 'success');
            }, 1000);
        }

        // Flatpickr ile tarih se√ßicileri ba≈ülat - resmi tatiller kƒ±rmƒ±zƒ± g√∂sterilir
        flatpickr("#startDate", {
            ...getFlatpickrConfig(),
            defaultDate: "2025-01-01"
        });

        flatpickr("#endDate", {
            ...getFlatpickrConfig(),
            defaultDate: "2025-12-31"
        });
    </script>
</body>
</html>